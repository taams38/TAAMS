<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAMS | Autonomous Protocol</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --bg-color: #030303;
            --panel-bg: rgba(10, 10, 10, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.15);
            --secondary: #ff00ff; /* Magenta pour Secondaire */
            --text-main: #ffffff;
            --text-dim: #666666;
            --font-head: 'Syncopate', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        /* --- WebGL Background --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.6; pointer-events: none;
        }

        /* --- Custom Cursor --- */
        .cursor {
            position: fixed; width: 6px; height: 6px; background: var(--accent);
            border-radius: 50%; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s;
            mix-blend-mode: exclusion;
        }
        .cursor.hovered { width: 60px; height: 60px; background: transparent; border: 1px solid var(--accent); opacity: 0.8; }

        /* --- Sidebar --- */
        aside {
            width: 320px; border-right: 1px solid var(--border);
            padding: 2rem; display: flex; flex-direction: column;
            z-index: 10; background: var(--bg-color);
        }

        .brand {
            font-family: var(--font-head); font-size: 1.6rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 3rem; letter-spacing: -1px;
            text-transform: uppercase;
        }
        .brand span { color: var(--accent); }

        nav button {
            background: transparent; border: none; color: var(--text-dim);
            font-family: var(--font-body); font-size: 0.9rem;
            text-align: left; padding: 1rem 0; width: 100%;
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
            border-left: 2px solid transparent;
        }
        nav button:hover { color: #fff; padding-left: 1rem; }
        nav button.active { color: var(--accent); border-left: 2px solid var(--accent); background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent); }
        
        .nav-section-title {
            font-size: 0.7rem;
            color: var(--text-dim);
            margin: 1.5rem 0 1.5rem 0 0.5rem 1.5rem 0;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        nav button.active {
            color: var(--accent); border-left: 2px solid var(--accent);
            background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent);
            background-position: 5px center; /* Petit indicateur vertical visuel */
        }

        /* --- Main Content --- */
        main {
            flex: 1; padding: 3rem; overflow-y: auto; position: relative; z-index: 10;
            display: flex; flex-direction: column;
        }

        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .card {
            background: var(--panel-bg); border: 1px solid var(--border);
            padding: 2rem; border-radius: 4px; margin-bottom: 2rem;
            backdrop-filter: blur(15px); transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .card:hover { border-color: rgba(255,255,255,0.2); }
        
        .card-header { font-family: var(--font-head); font-size: 1.2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; display: flex; justify-content: space-between;}

        /* --- Vitality Meter --- */
        .vitality-container {
            text-align: center; padding: 3rem 1rem;
            background: linear-gradient(180deg, rgba(0,255,136,0.05) 0%, transparent 100%);
            border: 1px solid var(--accent); margin-bottom: 3rem;
        }
        .vitality-title { font-family: var(--font-head); font-size: 2rem; margin-bottom: 1rem; color: #fff; }
        .progress-track { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin: 1rem auto; max-width: 600px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s ease; box-shadow: 0 0 20px var(--accent); }
        .vitality-stats { display: flex; justify-content: center; gap: 2rem; margin-top: 1.5rem; font-size: 1.2rem; color: var(--text-dim); }
        .vitality-stat span { color: #fff; font-weight: bold; }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 1.5rem; border: 1px solid var(--border); }
        .stat-val { font-family: var(--font-head); font-size: 1.8rem; color: #fff; margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; }

        /* --- Forms --- */
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            color: #fff; padding: 1rem; font-family: var(--font-body);
            margin-bottom: 1rem; border-radius: 2px; font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .btn {
            background: var(--accent); color: #000; border: none; padding: 1rem 2rem;
            font-weight: 700; text-transform: uppercase; cursor: pointer;
            border-radius: 2px; transition: all 0.2s; font-family: var(--font-head);
            font-size: 0.9rem; display: inline-block; margin-right: 0.5rem;
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--accent-glow); letter-spacing: 1px; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; background: #333; color: #888; }
        .btn.secondary { background: transparent; border: 1px solid #fff; color: #fff; }
        .btn.secondary:hover { background: #fff; color: #000; }
        .btn.danger { background: var(--secondary); color: #fff; }

        /* --- Notifications --- */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast { background: #111; color: #fff; padding: 1rem; border-left: 4px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slideIn 0.3s; pointer-events: auto; min-width: 300px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Vote Styles --- */
        .vote-step { border-left: 3px solid var(--border); padding-left: 1.5rem; margin-bottom: 2rem; position: relative; }
        .vote-step::before { content:''; position: absolute; left: -9px; top: 0; width: 15px; height: 15px; background: var(--bg-color); border: 2px solid var(--text-dim); border-radius: 50%; }
        .vote-step.active::before { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .step-title { font-weight: bold; color: var(--accent); text-transform: uppercase; font-size: 0.8rem; margin-bottom: 0.5rem; display: block; }
        .vote-data-display { background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 2px; margin-top: 1rem; display: none; }
        .vote-bar-container { display: flex; gap: 1rem; margin-top: 0.5rem; height: 8px; border-radius: 2px; background: #111; overflow: hidden; }
        .vote-bar { height: 100%; background: #222; border-radius: 2px; width: 0%; transition: width 0.3s ease; }
        
        /* --- Publicité (Advertisement) --- */
        .news-list { display: flex; flex-direction: column; gap: 1.5rem; }
        .news-item {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border); padding: 1rem; border-left: 4px solid var(--accent);
        }
        .news-date { font-size: 0.8rem; color: var(--accent); margin-bottom: 0.5rem; }
        .news-msg { font-family: var(--font-head); font-size: 1.1rem; color: #fff; }
        .news-desc { color: #ccc; font-size: 0.9rem; line-height: 1.5rem; }

        /* --- Whitepaper --- */
        #whitepaper-content { display: none; /* Hidden by default */
        
        /* Font styling for whitepaper */
        .wp-container {
            max-width: 800px;
            margin: 0 auto;
            background: #0808080; /* Dark Grey Paper effect */
            padding: 40px;
            border: 1px solid #333;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .wp-title { font-family: var(--font-head); font-size: 2rem; color: #fff; margin-bottom: 2rem; }
        
        .wp-section { margin-bottom: 2rem; }
        
        .wp-h2 { color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 1rem; font-size: 1.5rem; text-transform: uppercase;
        font-family: var(--font-head);
        }

        .wp-p { margin-bottom: 1rem; text-align: justify; line-height: 1.6rem; color: #ccc; }
        .wp-strong { color: var(--accent); }
        .wp-err { color: var(--secondary); } /* Magenta for errors */

        .wp-code {
            background: #000; border: 1px solid #444;
            padding: 1rem;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #00ff88;
            margin-bottom: 2rem;
            border-radius: 4px;
        }

        .wp-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
        .wp-table th, .wp-table td {
            border: 1px solid #444; padding: 10px; text-align: left;
        }
        .wp-table th {
            background: #111; color: #fff; font-weight: bold;
        }
        .wp-table tr:nth-child(even) { background: #0a0a0a; }

        /* --- Palette Table Styling (Wallet & Palette) --- */
        .color-box {
            width: 20px; 
            height: 20px; 
            display: inline-block; 
            vertical-align: middle; 
            border: 1px solid #ccc; 
            margin-right: 10px;
        }
        
        .palette-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 11pt;
        }

        .palette-table th, .palette-table td {
            border: 1px solid #cccccc;
            padding: 12px;
            text-align: left;
        }

        .palette-table th {
            background-color: #f2f2f2;
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            font-weight: bold;
        }

        .palette-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .security-box {
            border-left: 4px solid var(--accent, #00ff88);
            background: rgba(0,255,136,0.05);
            padding: 20px;
            margin: 20px 0;
        }
        
        .security-box p { margin-bottom: 15px; }

        /* Utility */
        .text-dim { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; display: block; line-height: 1.5rem; }
        .highlight { color: var(--accent); }
        .full-width { width: 100%; }

        .no-print { display: none; }
        
        /* Footer */
        .protocol-footer { margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; color: #444; font-size: 0.8rem; }
        .protocol-footer a { color: var(--accent); text-decoration: none; }
        .protocol-footer a:hover { text-decoration: underline; }
        
        /* Footer Specific for Whitepaper */
        .wp-footer { border-top: 1px solid #333; margin-top: 4rem; padding: 2rem; text-align: center; color: #666; font-size: 0.8rem; }
        .wp-footer strong { color: #fff; }
    </style>
</head>
<body>

    <div class="cursor" id="cursor"></div>
    <div id="toast-container"></div>
    <div id="canvas-container"></div>

    <!-- Sidebar -->
    <aside>
        <div class="brand">TAAMS <span>PROTOCOL</span></div>
        
        <div class="nav">
            <div class="nav-section-title">Actions</div>
            <button class="active" onclick="switchTab('dashboard')">Vitality & Ignition</button>
            <button onclick="switchTab('wallet')">Wallet</button>
            <button onclick="switchTab('burn')">Burn & BL2P</button>
            <button onclick="switchTab('staking')">Staking</button>
            <button onclick="switchTab('governance')">DAO & Governance</button>
            
            <div class="nav-section-title">Information</div>
            <button onclick="switchTab('wallet-palette')">Wallet & Palette</button>
            <button onclick="switchTab('publicite')">Publicité (Ads)</button>
            <button onclick="switchTab('whitepaper')">Livre Blanc (PDF)</button>
        </div>

        <div style="margin-top: auto;">
            <!-- Network Status Indicator -->
            <div id="network-display" style="margin-bottom: 1rem; text-align: center; font-size: 0.8rem;">
                Checking Network...
            </div>
            
            <div id="wallet-status" class="text-dim" style="text-align:center; margin-bottom:1rem;">Disconnected</div>
            <button id="connect-btn" class="btn full-width" style="width:100%" onclick="connectWallet()">CONNECT</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            
            <div class="vitality-container">
                <div class="vitality-title">PROTOCOL VITALITY</div>
                <p class="text-dim">The system depends entirely on community participation.</p>
                
                <div class="progress-track">
                    <div id="vitality-bar" class="progress-fill"></div>
                </div>
                
                <div class="vitality-stats">
                    <div class="vitality-stat"><span id="ign-count">0</span> / 1000</div>
                    <div class="vitality-stat">Founders</div>
                </div>

                <div id="ignition-message" style="margin-top: 2rem; font-family: var(--font-head);">
                    <!-- Dynamic Message -->
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-val" id="dash-balance">0</div>
                    <div class="stat-label">Your TAAMS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="dash-bl2p">0</div>
                    <div class="stat-label">Governance Power</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="dash-burned">0</div>
                    <div class="stat-label">Total Burned</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="total-staked-protocol">0</div>
                    <div class="stat-label">Total Staked (Global)</div>
                </div>
            </section>

            <div class="card">
                <div class="card-header">System Status</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                    <div>
                        <span class="text-dim">Burn Phase:</span>
                        <div id="status-burn" style="color: #fff;">Checking...</div>
                    </div>
                    <div>
                        <span class="text-dim">Ignition Triggered:</span>
                        <div id="status-ignition" style="color: #fff;">Checking...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- WALLET -->
        <section id="wallet" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Wallet Management</h2>
            
            <div class="card">
                <div class="card-header">Permissions (Approvals)</div>
                <span class="text-dim">Authorize protocol to manage your assets for Staking or Operations.</span>
                <div style="display:flex; gap:1rem;">
                    <input type="number" id="approve-amount" placeholder="TAAMS Amount">
                    <button class="btn" onclick="handleApprove()">APPROVE</button>
                </div>
                <div id="allowance-info" class="text-dim" style="font-size:0.8rem;">Current Allowance: Loading...</div>
            </div>

            <div class="card">
                <div class="card-header">Transfer</div>
                <span class="text-dim">Send TAAMS to another wallet address.</span>
                <input type="text" id="transfer-to" placeholder="Recipient Address (0x...)">
                <input type="number" id="transfer-amount" placeholder="Amount">
                <button class="btn" onclick="handleTransfer()">TRANSFER</button>
            </div>
        </section>

        <!-- BURN & BL2P -->
        <section id="burn" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Deflation & Governance</h2>

            <div class="card">
                <div class="card-header">Incinerate Tokens (Burn)</div>
                <span class="text-dim">Burning TAAMS permanently reduces supply and grants you BL2P (Governance Power). <br>The protocol lives through deflation.</span>
                
                <div style="margin: 1rem 0; padding:1rem; background:rgba(255,255,255,0.05);">
                    <span class="text-dim">Remaining in Cycle:</span> <span id="burn-remaining" class="highlight">Loading...</span>
                </div>

                <div style="display:flex; gap:1rem;">
                    <input type="number" id="burn-amount" placeholder="Amount to Burn">
                    <button class="btn" id="btn-burn" onclick="handleBurn()">BURN</button>
                </div>
                <button class="btn secondary" onclick="setInputMax('burn-amount')">SET MAX</button>
            </div>

            <div class="card">
                <div class="card-header">Claim Governance Rights (BL2P)</div>
                <span class="text-dim">Claim your voting power. This is non-transferable until maturity.</span>
                <button class="btn" id="btn-claim-bl2p" onclick="handleClaimBL2P()">CLAIM BL2P</button>
            </div>
        </section>

        <!-- STAKING -->
        <section id="staking" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Yield & Staking</h2>

            <div class="card">
                <div class="card-header">Protocol Staking Stats</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-val" id="total-staked-display">0</div>
                        <div class="stat-label">Total Staked (Global)</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-val" style="font-size:1.2rem; color:var(--accent);">1,000 TAAMS</div>
                        <div class="stat-label">Minimum Required</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">My Stake</div>
                
                <div id="user-stake-details" style="margin-bottom: 2rem; display:none; border: 1px solid var(--border); padding:1rem; border-radius:4px;">
                    <p style="color:#fff;"><strong>Amount:</strong> <span id="my-stake-amount" class="highlight">0</span> TAAMS</p>
                    <p style="color:#fff;"><strong>Boost (BL2P):</strong> <span id="my-stake-boost">0</span></p>
                    <p style="color:#fff;"><strong>Locked Since:</strong> <span id="my-stake-date">-</span></p>
                    <button class="btn danger" onclick="handleUnstake()">UNSTAKE ALL</button>
                </div>

                <div id="no-stake-msg" class="text-dim">You are not staking yet.</div>
            </div>

            <div class="card">
                <div class="card-header">Actions</div>
                <span class="text-dim">First Approve, then Stake. Minimum is 1000 TAAMS.</span>

                <div style="margin-bottom: 1rem;">
                    <input type="number" id="stake-amount" placeholder="Min: 1000 TAAMS">
                </div>

                <div style="margin-bottom: 1rem;">
                    <button class="btn secondary" onclick="setInputMax('stake-amount')">SET MAX</button>
                    <button class="btn" id="btn-approve-stake" onclick="handleApproveStake()">1. APPROVE STAKING</button>
                    <button class="btn" id="btn-stake-action" onclick="handleStake()">2. STAKE</button>
                </div>

                <div style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                    <span class="text-dim" style="color:var(--accent)">BOOST YIELD (Optional)</span>
                    <p style="font-size:0.8rem; color:#888; margin-bottom:0.5rem;">Use your BL2P (Governance Power) to increase your TAAMS yield.</p>
                    <div style="display: flex; gap: 1rem;">
                        <input type="number" id="boost-amount" placeholder="BL2P Amount">
                        <button class="btn secondary" onclick="handleBoost()">BOOST</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- GOVERNANCE -->
        <section id="governance" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Community Control</h2>

            <div class="card">
                <div class="card-header">Create Proposal</div>
                <span class="text-dim">Shape future of protocol. Requires Voting Power.</span>
                
                <select id="proposal-type">
                    <option value="0">Change Annual Burn Amount</option>
                    <option value="1">Change Staking Reward Rate</option>
                    <option value="2">Emergency Pause Protocol</option>
                    <option value="3">Unlock Reserve (Treasury)</option>
                    <option value="4">Post Advertisement (News)</option>
                    <option value="5">Adjust BL2P Maturation Time</option>
                    <option value="6">Change Quorum</option>
                </select>
                <input type="text" id="proposal-desc" placeholder="Proposal Description / News Message">
                <input type="number" id="proposal-value" placeholder="New Value (if applicable)">
                <input type="text" id="proposal-address" placeholder="New Address (if applicable)">
                <button class="btn" onclick="handleSubmitProposal()">SUBMIT PROPOSAL</button>
            </div>

            <div class="card">
                <div class="card-header">Vote (Commit & Reveal)</div>
                <span class="text-dim">Voting is anonymous and split into two phases to prevent corruption.</span>
                
                <!-- Step 1 -->
                <div class="vote-step">
                    <span class="step-title">Step 1: Load Proposal</span>
                    <div style="display:flex; gap:1rem;">
                        <input type="number" id="vote-proposal-id" placeholder="Proposal ID">
                        <button class="btn secondary" style="margin:0" onclick="loadProposal()">LOAD</button>
                    </div>
                    <div id="proposal-data" style="margin-top:1rem; display:none; background:rgba(0,0,0,0.3); padding:1rem;">
                        <p><strong>Desc:</strong> <span id="p-desc" style="color:var(--accent)"></span></p>
                        <p><strong>Type:</strong> <span id="p-type"></span></p>
                        <div style="display:flex; gap:2rem; margin-top:0.5rem;">
                            <span class="highlight">FOR: <span id="p-for"></span></span>
                            <span style="color:var(--secondary)">AGAINST: <span id="p-against"></span></span>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="vote-step">
                    <span class="step-title">Step 2: Commit Vote (Hide Choice)</span>
                    <input type="password" id="commit-secret" placeholder="Enter a Secret Password (Keep it!)">
                    <div style="display:flex; gap:1rem;">
                        <button class="btn" onclick="processCommitVote(true)">FOR</button>
                        <button class="btn danger" onclick="processCommitVote(false)">AGAINST</button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="vote-step">
                    <span class="step-title">Step 3: Reveal Vote</span>
                    <input type="password" id="reveal-secret" placeholder="Enter SAME Secret Password">
                    <div style="display:flex; gap:1rem;">
                        <button class="btn secondary" onclick="processRevealVote(true)">REVEAL FOR</button>
                        <button class="btn danger secondary" onclick="processRevealVote(false)">REVEAL AGAINST</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Delegation</div>
                <span class="text-dim">Trust an expert to vote on your behalf.</span>
                <input type="text" id="delegate-to" placeholder="Delegate Address">
                <input type="number" id="delegate-amount" placeholder="BL2P Amount">
                <button class="btn" onclick="handleDelegate()">DELEGATE</button>
                <button class="btn danger" onclick="handleRevokeDelegate()">REVOKE</button>
            </div>
        </section>

        <!-- PUBLICITE (Advertisement) -->
        <section id="publicite" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Publicité (Ads)</h2>
            
            <div class="news-list">
                <div class="news-item">
                    <div class="news-date">DATE: <span id="news-date-1">...</span></div>
                    <div class="news-msg">Message chargement...</div>
                </div>
                <div class="news-item">
                    <div class="news-date">DATE: <span id="news-date-2">...</span></div>
                    <div class="news-msg">Message chargement...</div>
                </div>
                <!-- Plus d'articles ici générés dynamiquement -->
                <div id="more-news" style="text-align: center; margin-top: 2rem;">
                    <button class="btn secondary" onclick="loadMoreNews()">CHARGER LA LISTE</button>
                </div>
            </section>

        <!-- WHITEPAPER (LIVRE BLANC) -->
        <section id="whitepaper" class="section">
            <div id="whitepaper-content">
                <div class="wp-container">
                    
                    <div class="wp-title">TAAMS PROTOCOL - LIVRE BLANC</div>
                    <div style="text-align: right; font-size: 0.9rem; color: var(--text-dim);">V1.0</div>
                    
                    <h2 id="wp-abs">Abstract</h2>
                        <div class="wp-p">TAAMS est un protocole financier autonome et déflationnaire déployé sur le réseau <strong>Polygon</strong>. Contrairement aux protocoles traditionnels, TAAMS ne dépend pas d'une autorité centrale pour sa gouvernance ou son évolution. Le système vit exclusivement grâce à la participation active de sa communauté ("Vitalité du Protocole"). Grâce à un mécanisme de "Burn-to-Governance", la réduction de l'offre (déflation) génère du pouvoir de vote (BL2P).</div>
                    
                    <h2 id="wp-intro">Introduction</h2>
                        <div class="wp-p">Le Problème</div>
                        <p class="wp-p">La DeFi actuelle souffre de deux maux majeurs :</p>
                        <ul class="wp-list">
                            <li class="wp-strong">Centralisation du Pouvoir :</strong> Les gros détenteurs de jetons (Whales) dictent souvent la direction des protocoles.</li>
                            <li class="wp-strong">Inflation et Sédimentation :</strong> L'expansion continue de l'offre dilue la valeur des utilisateurs passifs.</li>
                        </ul>
                        
                        <div class="wp-p">La Solution TAAMS</div>
                        <p class="wp-p">TAAMS introduit le concept de <strong>"Vitalité"</strong>. Le système ne s'active pleinement que si une masse critique d'utilisateurs (Les Fondateurs) s'engage.</p>
                    </div>

                    <h2 id="wp-tech">Architecture Technique</h2>
                        <div class="wp-p">Infrastructure</div>
                        <ul>
                            <li class="wp-list"><strong>Blockchain :</strong> Polygon (Layer 2) pour des frais de gaz négligeables et une haute vitesse.</li>
                            <li class="wp-list"><strong>Contrat Principal :</strong> TAAMS (ERC-20, Gouvernance, Staking, Airdrop).</li>
                            <li class="wp-list"><strong>Standard :</strong> Solidity ^0.8.20 (OpenZeppelin).</li>
                        </ul>
                        
                        <div class="wp-p">Sécurité</div>
                        <p class="wp-p">Le contrat intègre plusieurs garde-fous de sécurité industriels :</p>
                        <ul>
                            <li class="wp-list"><strong>ReentrancyGuard :</strong> Empêche les attaques de réentrance.</li>
                            <li class="wp-list"><strong>Ownable & Pausable :</strong> Mécanismes d'arrêt d'urgence.</li>
                            <li class="wp-list"><strong>Système de Vote (Commit/Reveal) :</strong> Empêche la corruption des votes.</li>
                            <li class="wp-list"><strong>Inactivity Burn :</strong> Les droits de vote inutilisés sont détruits.</li>
                        </ul>
                    </div>

                    <h2 id="wp-token">Le Token TAAMS</h2>
                        <div class="wp-p">TAAMS est le jeton natif de l'écosystème.</div>
                        <div class="wp-section">
                            <h3 style="color:var(--accent);">Spécifications :</h3>
                            <ul>
                                <li class="wp-list"><strong>Nom :</strong> TAAMS</li>
                                <li class="wp-list"><strong>Symbole :</strong> TAAMS</li>
                                <li class="wp-list"><strong>Décimales :</strong> 18</li>
                                <li class="wp-list"><strong>Offre Totale :</strong> 10,000,000,000 TAAMS (10 Milliards)</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3 style="color:var(--text-dim);">Rôles :</h3>
                            <ul>
                                <li><strong>Moyen d'échange :</strong> Sur les DEX (Unicwap, QuickSwap).</li>
                                <li><strong>Carburant pour le Protocole :</strong> Utilisé pour le Staking et le Burn.</li>
                                <li><strong>Réserve de Valeur :</strong> Unité de compte pour les récompenses.</li>
                            </ul>
                        </div>
                    </div>

                    <h2 id="wp-ignition">La Phase d'Ignition (Airdrop)</h2>
                        <div class="wp-p">Avant que la gouvernance ne soit transférée à la communauté, le protocole doit prouver sa vitalité.</div>
                        <div class="wp-section">
                            <h3 style="color:var(--text-dim);">Le Concept des Fondateurs</h3>
                            <p class="wp-p">L'inscription est ouverte aux 1000 premiers participants (Founders). Ce groupe d'initiés est crucial car ils sont les premiers à bénéficier de la redistribution massique de l'offre (le Burn).</p>
                        </div>
                        <div class="wp-section">
                            <h3 style="color:var(--text-dim);">L'Allumage (Trigger)</h3>
                            <p class="wp-p">Une fois que 1000 utilisateurs se sont inscrits et que l'offre en circulation atteint le seuil d'activation (1 Milliard de TAAMS), l'<strong>Ignition Airdrop</strong> est déclenché automatiquement.</p>
                            <ul>
                                <li><strong>Pool Airdrop :</strong> 500,000,000 TAAMS (5% de l'offre totale).</li>
                                <li><strong>Distribution :</strong> Rang 1-100 : 150% de la part de base.</li>
                                <li><strong>Rang 101-200 : 125% de la part de base.</li>
                                <li><strong>Rang 201-1000 : 100% de la part de base.</li>
                            </ul>
                        </div>
                        <p class="wp-p">Une fois l'Ignition terminée, la propriété du contrat est transférée à la DAO, rendant le système <strong>100% Autonome</strong>.</p>
                    </div>

                    <h2 id="wp-burn">Mécanisme de Burn & BL2P</h2>
                        <div class="wp-p">C'est le cœur économique du protocole. C'est ici que l'utilisateur transforme sa richesse (TAAMS) en pouvoir (BL2P).</div>
                        <div class="wp-section">
                            <h3>Le BL2P (Gouvernance Power)</h3>
                            <p class="wp-p">Le <strong>BL2P</strong> est un jeton de gouvernance interne (non-ERC20 transférable) avec des propriétés uniques :</p>
                            <ul>
                                <li><strong>Non Transférable :</strong> Vous ne pouvez pas vendre vos BL2P. Vous devez les gagner en participant (Burn).</li>
                                <li><strong>Maturité :</strong> Les BL2P gagnent en pouvoir de vote avec le temps (contrôle l'inactivité).</li>
                                <li><strong>Décroissance Inactivité :</strong> Si vous ne votez pas, vos BL2P sont brûlés progressivement.</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Le Cycle de Burn</h3>
                            <p class="p">Le protocole vise à brûler <strong>1 Milliard de TAAMS</strong> au total.</p>
                            <ul>
                                <li><strong>Mécanisme :</strong> L'utilisateur envoie des TAAMS au contrat pour destruction.</li>
                                <li><strong>Récompense (BL2P) :</strong> Le brûlage accorde des jetons de gouvernance (BL2P).</li>
                                <li><strong>Pool de Récompense :</strong> 1 Milliard de BL2P sont distribués proportionnellement à tous les brûleurs, une fois l'objectif atteint.</li>
                            </ul>
                        </div>
                    </div>

                    <h2 id="wp-stake">Staking & Rendement</h2>
                        <div class="wp-p">Le staking permet aux utilisateurs de bloquer leurs TAAMS pour générer des rendements.</p>
                        <div class="wp-section">
                            <h3>Règles du Staking</h3>
                            <ul>
                                <li><strong>Minimum :</strong> Il faut staker au minimum <strong>1,000 TAAMS</strong>.</li>
                                <li><strong>Durée de verrouillage :</strong> Flexible (retrait possible à tout moment, mais les intérêts sont calculés par blocs/périodes).</li>
                                <li><strong>Taux de Rendement (APY) :</strong> 5% par défaut (Modifiable par DAO).</li>
                                <li><strong>Calcul :</strong> Rendement = (Montant Staké * Taux x Temps).</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Le "Boost" BL2P</h3>
                            <p class="p">Une innovation unique. Un utilisateur peut sacrifier son pouvoir de vote (BL2P) pour augmenter ses gains de staking.</p>
                            <ul>
                                <li><strong>Mécanisme :</strong> Brûler des BL2P sur un stake actif.</li>
                                <li><strong>Limite :</strong> Le boost ne peut pas dépasser 10% du montant staké.</li>
                                <li><strong>Arbitrage :</strong> L'utilisateur doit choisir entre <strong>Gouvernance (Pouvoir de Vote)</strong> ou <strong>Finance (Plus de Rendement)</strong>.</li>
                            </ul>
                        </div>
                    </div>

                    <h2 id="wp-gov">Gouvernance (DAO)</h2>
                        <p>Une fois l'Ignition terminée, le contrat devient propriété de la communauté.</p>
                        <div class="wp-section">
                            <h3>Système de Vote à 2 Étapes (Commit/Reveal)</h3>
                            <p>Pour éviter que les gros détenteurs ne puissent pas influencer le vote par leur simple présence, TAAMS utilise le système <strong>Commit / Reveal</strong>.</p>
                            <ol>
                                <li><strong>Commit :</strong> L'utilisateur envoie un hash secret de son choix (Pour/Contre). Personne ne sait ce qu'il a voté.</li>
                                <li><strong>Reveal :</strong> À la fin de la période de vote, l'utilisateur révèle son choix et son secret. Le contrat vérifie que cela correspond au hash initial.</li>
                            </ol>
                        </div>
                        <div class="wp-section">
                            <h3>Propositions</h3>
                            <p>Les gouvernés peuvent proposer des changements via différents types de propositions :</p>
                            <ul>
                                <li><strong>Burn Amount :</strong> Modifier le montant cible de burn.</li>
                                <li><strong>Reward Rate :</strong> Changer l'APY du staking.</li>
                                <li><strong>Unlock Reserve :</strong> Débloquer la trésorerie.</li>
                                <strong>Advertisement :</strong> Poster des annonces officielles sur la chaîne.</li>
                                <li><strong>Quorum & Threshold :</strong> Changer les règles de vote.</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Délégation</h3>
                            <p>Si un utilisateur ne souhaite pas voter, il peut déléguer ses BL2P à un tiers expert. La délégation est révocable à tout moment.</p>
                        </div>
                    </div>

                    <h2 id="wp-tok">Distribution & Tokenomics</h2>
                        <p>L'offre totale de <strong>10 Milliards de TAAMS</strong> est répartie comme suit :</p>
                        <div class="wp-table-wrapper">
                            <table class="wp-table">
                                <thead>
                                    <tr>
                                        <th>Catégorie</th>
                                        <th>Allocation</th>
                                        <th>Montant</th>
                                        <th>Conditions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Locked Reserve</strong></td>
                                        <td>70%</td>
                                        <td>7,000,000,000</td>
                                        <td>Débloquée progressivement par la DAO.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ignition Airdrop</strong></td>
                                        <td>5%</td>
                                        <td>500,000,000</td>
                                        <td>Distribué aux 1000 fondateurs.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Deployer / Recipient</strong></td>
                                        <td>20%</td>
                                        <td>2,000,000,000</td>
                                        <td>Initial liquidity & Développement.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Burn Pool (Target)</strong></td>
                                        <td>10%</td>
                                        <td>1,000,000,000</td>
                                        <td>Brûlé par les utilisateurs pour mint du BL2P.</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Staking Rewards</strong></td>
                                        <td>Illimité</td>
                                        <td>Variable</td>
                                        <td>Mintés dynamiquement sur le rendement.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <p><strong>Note Importante :</strong> Le contrat ne possède pas de "Minting Authority" infinie. L'inflation ne se produit que via le Staking, qui est contrôlé par la communauté.</p>
                    </div>

                    <h2 id="wp-roadmap">Roadmap</h2>
                        <div class="wp-section">
                            <h3>Phase 1 : La Création (Q1 2025)</h3>
                            <ul>
                                <li>Déploiement sur Polygon Mainnet.</li>
                                <li>Lancement de la DApp Web3.</li>
                                <li>Phase d'inscription aux 1000 fondateurs.</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Phase 2 : L'Ignition (Q2 2025)</h3>
                            <ul>
                                <li>Distribution des 500M TAAMS d'Airdrop.</li>
                                <li>Transfert de la gouvernance à la DAO.</li>
                                <li>Activation du mécanisme de Burn.</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Phase 3 : La DAO Vivante (Q3 2025)</h3>
                            <ul>
                                <li>Premières propositions de gouvernance.</li>
                                <li>Lancement du staking décentralisé.</li>
                                <li>Lancement du système de "Publicité" sur la blockchain.</li>
                            </ul>
                        </div>
                        <div class="wp-section">
                            <h3>Phase 4 : L'Expansion (2026+)</h3>
                            <ul>
                                <li>Intégration de nouveaux contrats.</li>
                                <li>Partenariats.</li>
                                <li>Autonomie totale via la gouvernance BL2P.</li>
                            </ul>
                        </div>
                    </div>

                    <hr style="border: 0; border-top: 1px solid var(--border); margin: 50px 0;">

                    <div class="wp-footer">
                        <strong>Construit avec autonomie par la communauté TAAMS.</strong>
                        <br>
                        <em>Version : 1.0 • Réseau : Polygon Mainnet (137)</em>
                    </div>
                </div>

                <div id="wp-nav" style="text-align: center; margin-top: 3rem;">
                    <button class="btn secondary" onclick="switchTab('dashboard')">Retour Dashboard</button>
                </div>
            </div>
        </section>

        <div class="protocol-footer">
            TAAMS PROTOCOL // AUTONOMOUS SYSTEM // COMMUNITY DRIVEN
        </div>

    </main>

    <script>
        // ==========================================
        // CONFIGURATION (MODIFIEZ L'ADRESSE DU CONTRAT ICI
        // ==========================================
        
        // IMPORTANT: ADRESSE DU CONTRAT DEPLOYÉ
        const CONTRACT_ADDRESS = "0xbAC8aC29CddD32997D7dDA8cc27DAB261327e1Ef"; 

        // ABI COMPLET AVEC TOUTES LES NOUVELLES FONCTIONS
        const CONTRACT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function decimals() view returns (uint8)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address, uint256) returns (bool)",
            "function allowance(address, address) view returns (uint256)",
            "function approve(address, uint256) returns (bool)",
            "function transferFrom(address, address, uint256) returns (bool)",
            "function partipateInBurn(uint256 amount) external nonReentrant whenNotPaused onlyEOA",
            "function claimBL2PReward() external nonReentrant whenNotPaused",
            "function registerForIgnitionAirdrop() external nonReentrant whenNotPaused onlyEOA",
            "function triggerIgnitionAirdrop() external onlyGovernanceOrOwner",
            "function setIgnitionRegistrationStatus(bool isOpen) external onlyGovernanceOrOwner",
            "function claimIgnitionAirdrop() external nonReentrant",
            "function batchClaimBL2PReward(address[] memory) external nonReentrant whenNotPaused",
            "function submitProposal(string memory desc, uint256 newValue, address newAddress, uint8 proposalType) external whenNotPaused",
            "function commitVote(uint256 id, bytes32 commitHash) external whenNotPaused",
            "function revealVote(uint256 id, bool support, bytes32 secret) external whenNotPaused",
            "function executeProposal(uint256 id) external nonReentrant whenNotPaused",
            "function delegateVote(address delegate, uint256 amount) external whenNotPaused",
            "function revokeDelegation() external whenNotPaused",
            "function setGovernanceContract(address newContract) external onlyGovernanceOrOwner",
            "function useBL2PForStaking(uint256 bl2pAmount) external whenNotPaused",
            "function transfer(address to, uint256 amount) external nonReentrant whenNotPaused",
            function transferBL2P(address to, uint256 amount) external nonReentrant whenNotPaused",
            function stake(uint256 amount) external nonReentrant whenNotPaused onlyEOA",
            function unstake() external nonReentrant whenNotPaused onlyEOA",
            function _burnInactiveBL2P(address user) external nonReentrant onlyGovernanceOrUser(user) {
                burnInactiveBL2P(user);
            },
            "function getIgnitionInfo() external view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed)",
            "function getIgnitionParticipants() external view returns (address[] memory)",
            "function getRemainingBurnable() external view returns (uint256)",
            "function getRemainingValidBL2P(address) view returns (uint256)",
            "function getBL2PLifetime(address) view returns (uint256 birthBlock, uint256 expiryBlock)",
            "function getTopDelegates() external view returns (address[] memory)",
            "function getLastProposer() view returns (address)",
            "function getRemainingValidBL2P(address user) view returns (uint256)", /* Added from "GetRemainingValidBL2P" logic in contract */
            "function transfer(address to, uint256 value) override nonReentrant whenNotPaused onlyEOA",
            "function transferFrom(address sender, address to, uint256 value) override nonReentrant whenNotPaused onlyEOA",
            "function useBL2PForStaking(uint256 bl2pAmount) external nonReentrant whenNotPaused onlyEOA",
            function updateBL2PMaturity(address user) public {
                updateBL2PMaturity(msg.sender);
            },
            function bl2pLifespanBlocks() view returns (uint256)",
            "function inactivityBurnRate() view returns (uint256)",
            function maxDelegatedBL2PPercent() view returns (uint256)",
            "function verifyBL2PIntegrity(address[] memory users) external view returns (bool isValid, uint256 totalBL2P)",
            "function burnPhaseActive() view returns (bool)",
            "function bl2pRevealed() view returns (bool)",
            "function ignitionAirdropTriggered() view returns (bool)",
            "function lastAdvertisementTimestamp() view returns (uint256)",
            "function advertisements(uint256) view returns (uint256 id, uint256 postedBlock, string message);",
            "function advertisementCount() view returns (uint256)",
            "function activeDelegations(address) view returns (address source, address delegate, uint256 bl2pAmount, uint256 delegationBlock);",
            "function delegatedBL2PReceived(address) view returns (uint256)",
            "function stakes(address) view returns (uint256 amount, uint256 startBlock, uint256 bl2pBoost, bool active);",
            "function proposalCount() view returns (uint256)",
            "function totalBurned() view returns (uint256)",
            "function totalContributions(address) view returns (uint256)",
            "function totalStaked() view returns (uint256)",
            "function totalSupply() view returns (uint256)",
            "function getRemainingBurnable() view returns (uint256)",
            "function postAdvertisement(string memory desc) external onlyGovernanceOrOwner",
            "function checkActivation() external whenNotPaused",
            "function renounceOwnership() public virtual override onlyOwner",
            "function _transfer(address, address, uint256) override internal returns (bool)",
            "function _mint(address, uint256) internal returns (uint256);",
            "function _burn(address, uint256) internal returns (uint256);",
            "function _approve(address, uint256) internal returns (uint256);",
            "function _transfer(address, address, uint256) internal returns (bool);",
            "function _update(address, address, uint256) internal virtual (bool);",
            "function _mint(address, uint256) internal (uint256) internal (uint256);",
            "function _burn(address, uint256) internal (uint256);",
            "function _approve(address, uint256) internal (uint256);",
            "function _updateBL2PMaturity(address user) public",
            "function transferBL2P(address, uint256) external nonReentrant whenNotPaused",
            "function useBL2PForStaking(uint256 bl2pAmount) external nonReentrant whenNotPaused",
            "function unstake() external nonReentrant whenNotPaused onlyEOA",
            function claimBL2PReward() external nonReentrant whenNotPaused",
            "function batchClaimBL2PReward(address[] memory users) external nonReentrant whenNotPaused",
            "function submitProposal(string memory desc, uint256 newValue, address newAddress, uint8 proposalType) external whenNotPaused",
            "function commitVote(uint256 id, bytes32 commitHash) external whenNotPaused",
            "function revealVote(uint256 id, bool support, bytes32 secret) external whenNotPaused",
            "function executeProposal(uint256 id) external nonReentrant whenNotPaused",
            "function delegateVote(address delegate, uint256 amount) external whenNotPaused",
            "function revokeDelegation() external nonReentrant whenNotPaused",
            "function updateBL2PMaturity(address user) public { updateBL2PMaturity(msg.sender); },
            "function transferBL2P(address to, uint256 amount) external nonReentrant whenNotPaused",
            "function getBL2PLifetime(address user) view returns (uint256 birthBlock, uint256 expiryBlock);",
            "function getRemainingValidBL2P(address user) view returns (uint256)",
            "function getTopDelegates() external view returns (address[] memory);",
            "function getLastProposer() external view returns (address);",
            "function getRemainingBurnable() external view returns (uint256);",
            "function getRemainingValidBL2P(address user) view returns (uint256);",
            "function totalBurned() external view returns (uint256);",
            "function totalContributions(address) view returns (uint256);",
            "function getIgnitionInfo() external view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed);",
            "function getIgnitionParticipants() external view returns (address[] memory);",
            "function getTopDelegates() external view returns (address[] memory);",
            "function verifyBL2PIntegrity(address[] memory users) external view returns (bool isValid, uint256 totalBL2P);",
            "function postAdvertisement(string memory desc) external onlyGovernanceOrOwner",
            "function postAdvertisementCount() external view returns (uint256);",
            "function lastAdvertisementTimestamp() external view returns (uint256);",
            "function checkActivation() external whenNotPaused",
            "function transfer(address recipient, uint256 amount) override (bool) whenNotPaused",
            "function transferFrom(address sender, address recipient, uint256 value) override (bool) whenNotPaused",
            "function updateBL2PMaturity(address user) external nonReentrant whenNotPaused",
            "function useBL2PForStaking(uint256 bl2pAmount) external nonReentrant whenNotPaused",
            "function stake(uint256 amount) external nonReentrant whenNotPaused onlyEOA",
            "function unstake() external nonReentrant whenNotPaused onlyEOA",
            "function claimBL2PReward() external nonReentrant whenNotPaused",
            "function batchClaimBL2PReward(address[] memory users) external nonReentrant whenNotPaused",
            "function submitProposal(string memory desc, uint256 newValue, address newAddress, uint8 proposalType) external whenNotPaused",
            "function commitVote(uint256 id, bytes32 commitHash) external whenNotPaused",
            "function revealVote(uint256 id, bool support, bytes32 secret) external whenNotPaused",
            "function executeProposal(uint256 id) external nonReentrant whenNotPaused",
            "function delegateVote(address delegate, uint256 amount) external nonReentrant whenNotPaused",
            "function revokeDelegation() external nonReentrant whenNotPaused",
            "function setGovernanceContract(address newContract) external onlyGovernanceOrOwner",
            "function setIgnitionRegistrationStatus(bool isOpen) external onlyGovernanceOrOwner",
            "function triggerIgnitionAirdrop() external onlyGovernanceOrOwner",
            "function registerForIgnitionAirdrop() external nonReentrant whenNotPaused onlyEOA",
            "function claimIgnitionAirdrop() external nonReentrant",
            "function batchClaimBL2PReward(address[] memory users) external nonReentrant whenNotPaused",
            "function getIgnitionInfo() external view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed)",
            "function getIgnitionParticipants() external view returns (address[] memory)",
            "function getRemainingBurnable() external view returns (uint256)",
            "function getRemainingValidBL2P(address user) external view returns (uint256)",
            "function getBL2PLifetime(address user) view returns (uint256 birthBlock, uint256 expiryBlock);",
            "function getTopDelegates() external view returns (address[] memory);",
            "function getLastProposer() external view returns (address);",
            "function getRemainingBurnable() external view returns (uint256);",
            "function transfer(address to, uint256 value) external nonReentrant whenNotPaused onlyEOA",
            "function transferBL2P(address to, uint256 amount) external nonReentrant whenNotPaused",
            "function transferFrom(address sender, address to, uint256 value) external nonReentrant whenNotPaused onlyEOA",
            "function transferFrom(address sender, address to, uint256 value) returns (bool);", /* Added as override for logic check */
            "function checkActivation() external whenNotPaused",
            "function totalSupply() external view returns (uint256);",
            "function decimals() external view returns (uint8);",
            "function symbol() external view returns (string);"
        ];

        let provider, signer, userAddress, contract;
        let isConnected = false;

        // ==========================================
        // UI UTILITIES & NAVIGATION
        // ==========================================
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
            
            // Scroll to top automatically on tab switch
            document.querySelector('main').scrollTop = 0;
        }

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            if(type === 'error') t.style.borderLeftColor = '#ff00ff';
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        function setInputMax(id) {
            const el = document.getElementById(id);
            if(id === 'burn-amount' || id === 'stake-amount') {
                const elBal = document.getElementById('dash-balance').getAttribute('data-raw');
                el.value = parseFloat(ethers.formatEther(elBal)).toFixed(2);
            } else {
                const bal = document.getElementById('dash-balance').getAttribute('data-raw');
                el.value = parseFloat(ethers.formatEther(bal)).toFixed(2);
            }
        }

        // Custom Cursor
        document.addEventListener('mousemove', e => {
            const c = document.getElementById('cursor');
            c.style.left = e.clientX + 'px';
            c.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('button, input, .tab-trigger').forEach(el => {
            el.addEventListener('mouseenter', () => document.getElementById('cursor').classList.add('hovered'));
            el.addEventListener('mouseleave', () => document.getElementById('cursor').classList.remove('hovered'));
        });

        // ==========================================
        // NETWORK HANDLING (AUTO & POLYGON)
        // ==========================================
        const POLYGON_CHAIN_ID = 137;
        const POLYGON_HEX_ID = "0x89";
        const POLYGON_RPC_URL = "https://polygon-rpc.com/";
        const POLYGON_BLOCK_EXPLORER = "https://polygonscan.com";

        async function checkNetwork() {
            if (!window.ethereum) return;
            try {
                const network = await provider.getNetwork();
                const chainId = Number(network.chainId);
                const networkDiv = document.getElementById('network-display');
                
                if (chainId !== POLYGON_CHAIN_ID) {
                    networkDiv.innerHTML = `
                        <span class="network-badge network-wrong" onclick="switchToPolygon()">
                            ⚠ Wrong Network (Click to Switch to Polygon)
                        </span>`;
                    showToast("Veuillez changer de réseau pour Polygon", "error");
                    return false;
                } else {
                    networkDiv.innerHTML = `
                        <span class="network-badge network-polygon">
                            ✓ Polygon Mainnet
                        </span>`;
                    return true;
                }
            } catch (e) {
                console.error("Erreur checkNetwork", e);
                return false;
            }
        }

        async function switchToPolygon() {
            if (!window.ethereum) return showToast("Metamask not found", "error");
            
            try {
                showToast("Basculement vers Polygon...", "info");
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_HEX_ID }],
                });
            } catch (switchError) {
                // This error code indicates that the chain has not been added to MetaMask.
                if (switchError.code === 4902) {
                    showToast("Ajout de Polygon à Metamask...", "info");
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [
                                {
                                    chainId: POLYGON_HEX_ID,
                                    chainName: 'Polygon Mainnet',
                                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                    rpcUrls: [POLYGON_RPC_URL],
                                    blockExplorerUrls: [POLYGON_BLOCK_EXPLORER]
                                },
                            ],
                        });
                    } catch (addError) {
                        showToast("Erreur ajout réseau: " + addError.message, "error");
                    }
                } else {
                    showToast("Erreur changement réseau: " + switchError.message, "error");
                }
            }
        }

        // ==========================================
        // WEB3 LOGIC (AUTO-CONNECTION)
        // ==========================================
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
                location.reload();
            });
            window.ethereum.on('chainChanged', () => {
                location.reload();
                checkNetwork();
            });
        }

        window.addEventListener('load', async () => {
            const savedAddress = localStorage.getItem('taams_user_address');
            if (savedAddress && window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    if (accounts.length > 0) {
                        connectWallet();
                    } else {
                        localStorage.removeItem('taams_user_address');
                    }
                } catch (e) {
                    console.log("Auto-connect bloqué par l'utilisateur", e);
                    localStorage.removeItem('taams_user_address');
                }
            }
        });

        async function connectWallet() {
            if (!window.ethereum) return showToast("Metamask not found", "error");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Sauvegarde la connexion
                localStorage.setItem('taams_user_address', userAddress);
                
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                isConnected = true;
                
                document.getElementById('wallet-status').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                document.getElementById('connect-btn').style.display = 'none';
                showToast("Connected to Autonomous Protocol");
                
                const isCorrectNetwork = await checkNetwork();
                if (!isCorrectNetwork) return; 

                // Auto-refresh loop
                refreshData();
                setInterval(refreshData, 5000);
            } catch (err) { console.error(err); showToast("Connection Failed", "error"); }
        }

        // ==========================================
        // LOGIC REFRESH (DATA FETCH)
        // ==========================================
        async function refreshData() {
            if (!contract) return;
            try {
                // --- Vitality & Ignition ---
                const ignInfo = await contract.getIgnitionInfo();
                const currentCount = Number(ignInfo.participants);
                const maxCount = 1000;
                const percent = Math.min((currentCount / maxCount) * 100, 100);
                
                document.getElementById('ign-count').innerText = currentCount;
                document.getElementById('vitality-bar').style.width = `${percent}%`;
                
                const msgDiv = document.getElementById('ignition-message');
                if(!ignInfo.triggered) {
                    if(ignInfo.regOpen) {
                        if(ignInfo.userRegistered) {
                            msgDiv.innerHTML = `<span class="highlight">VOUS ÊTES INSCRIT.</span><br><span class="text-dim">En attente de 1000 fondateurs...</span>`;
                        } else {
                            msgDiv.innerHTML = `<button class="btn" onclick="handleRegisterAirdrop()">REJOINDRE L'IGNITION</button>`;
                        }
                    } else {
                        msgDiv.innerHTML = `<span style="color:var(--secondary)">INSCRIPTION FERMÉE</span>`;
                    }
                } else {
                    if(ignInfo.userRegistered && !ignInfo.userClaimed && ignInfo.userAmount > 0n) {
                        msgDiv.innerHTML = `<button class="btn" onclick="handleClaimAirdrop()">RÉCLAMER VOS TAAMS</button>`;
                    } else {
                        msgDiv.innerHTML = `<span class="highlight">IGNITION TERMINÉE</span><br><span class="text-dim">Le protocole est en vie.</span>`;
                    }
                }

                // --- Dashboard Stats ---
                const bal = await contract.balanceOf(userAddress);
                const bl2p = await contract.getRemainingValidBL2P(userAddress);
                const burned = await contract.totalBurned();
                const totalStaked = await contract.totalStaked();
                
                document.getElementById('dash-balance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(2);
                document.getElementById('dash-balance').setAttribute('data-raw', bal);
                document.getElementById('dash-bl2p').innerText = parseFloat(ethers.formatEther(bl2p)).toFixed(2);
                document.getElementById('dash-burned').innerText = parseFloat(htmlDisplayEthers(burned)).toLocaleString(); // Added helper for formatting large numbers

                document.getElementById('dash-staked').innerText = parseFloat(htmlDisplayEthers(totalStaked)).toLocaleString();

                document.getElementById('status-burn').innerText = await contract.burnPhaseActive() ? "ACTIF" : "INACTIF";
                document.getElementById('status-ignition').innerText = ignInfo.triggered ? "OUI" : "NON";
                
                // --- Burn Info ---
                const rem = await contract.getRemainingBurnable();
                document.getElementById('burn-remaining').innerText = htmlDisplayEthers(rem);

                // --- Staking (Correction Tableau) ---
                const stake = await contract.stakes(userAddress);
                if (stake.active) {
                    document.getElementById('user-stake-details').style.display = 'block';
                    document.getElementById('user-stake-amount').innerText = htmlDisplayEthers(stake.amount);
                    document.getElementById('user-stake-boost').innerText = htmlDisplayEthers(stake.bl2pBoost);
                    document.getElementById('user-stake-date').innerText = new Date(Number(stake.startBlock) * 1000).toLocaleDateString();
                } else {
                    document.getElementById('user-stake-details').style.display = 'none';
                    document.getElementById('no-stake-msg').style.display = 'block';
                }

            } catch (e) {
                console.error("Erreur Refresh Data:", e);
                const errorMsg = e.reason || e.message || JSON.stringify(e);
                if(errorMsg && errorMsg !== "") {
                    console.warn("Erreur:", errorMsg);
                }
            }
        }

        // --- HELPER FUNCTIONS (CORRIGÉES) ---
        async function handleApprove() {
            const amt = document.getElementById('approve-amount').value;
            if(!amt) return showToast("Montant requis", "error");
            try {
                const tx = await contract.approve(CONTRACT_ADDRESS, ethers.parseEther(amt));
                showToast("Envoi d'approbation...");
                await tx.wait();
                showToast("Approuvé !");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleTransfer() {
            const to = document.getElementById('transfer-to').value;
            const amt = document.getElementById('transfer-amount').value;
            if(!to || !amt) return showToast("Veuillez remplir tous les champs", "error");
            try {
                const tx = await contract.transfer(to, ethers.parseEther(amt));
                showToast("Transferring...");
                await tx.wait();
                showToast("Transfert réussi !");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- IGNITION ---
        async function handleRegisterAirdrop() {
            try {
                const tx = await contract.registerForIgnitionAirdrop();
                showToast("Inscription...");
                await tx.wait();
                showToast("Inscription Réussie !");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleClaimAirdrop() {
            try {
                const tx = await contract.claimIgnitionAirdrop();
                showToast("Réclamation en cours...");
                await tx.wait();
                showToast("Réclamation réussie !");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- BURN ---
        async function handleBurn() {
            const amt = document.getElementById('burn-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.participateInBurn(ethers.parseEther(amt));
                showToast("En cours de Burn...");
                await tx.wait();
                showToast("Burn Complete");
                refreshData();
            } catch(e) { showToast(e.reason || e.message || "Burn Failed", "error"); }
        }

        async function handleClaimBL2P() {
            try {
                const tx = await contract.claimBL2PReward();
                showToast("Réclamation en cours...");
                await tx.wait();
                showToast("BL2P Reçu !");
                refreshData();
            } catch(e) { showToast(e.reason || e.message, "error"); }
        }

        // --- STAKING ---
        async function handleStake() {
            const amt = document.getElementById('stake-amount').value;
            if(!amt) return;
            try {
                const amount = ethers.parseEther(amt);
                // Vérification simple du minimum (1e3 * 1e18)
                const MIN_STAKE = ethers.parseEther("1000");
                if(amount < MIN_STAKE) return showToast("Minimum 1000 TAAMS required", "error");
                
                const tx = await contract.stake(amount);
                showToast("Staking...");
                await tx.wait();
                showToast("Staké avec succès !");
                refreshData();
            } catch(e) {
                let reason = e.reason || e.message || "Erreur inconnue";
                
                if (reason.includes("BelowMinimumStake")) {
                    reason = "Il faut minimum 1000 TAAMS !";
                } else if (reason.includes("ERC20InsufficientAllowance")) {
                    reason = "Approuvez le contrat pour Staking (Approve)";
                } else if (reason.includes("StakeAlreadyActive")) {
                    reason = "Déjà en stake";
                } else if (reason.includes("execution reverted")) {
                    reason = "Échec contrat.";
                }

                showToast(reason, "error");
                document.getElementById('btn-stake-action').innerText = "2. STAKE";
            }
        }

        async function handleBoost() {
            const amt = document.getElementById('boost-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.useBL2PForStaking(ethers.parseEther(amt));
                showToast("Boost en cours...");
                await tx.wait();
                showToast("Boosté !");
                refreshData();
            } catch(e) {
                console.error(e);
                showToast(e.reason, "error");
            }
        }

        async function handleUnstake() {
            try {
                const tx = await contract.unstake();
                showToast("Unstaking...");
                await tx.wait();
                showToast("Unstaké !");
                refreshData();
            } catch(e) {
                showToast(e.reason || "Error", "error");
            }
        }

        // --- GOVERNANCE ---
        
        async function handleSubmitProposal() {
            const type = document.getElementById('proposal-type').value;
            const desc = document.getElementById('proposal-desc').value;
            const val = document.getElementById('proposal-value').value;
            const addr = document.getElementById('proposal-address').value;
            
            // Validation des champs selon le type
            if (['2','3','4'].includes(type) && !desc) return showError("Description requisee pour ce type de proposition", "error");
            if (type != '4' && !addr) return showError("L'adresse du destinataire est requise pour ce type", "error");
            if (type != '2' && !val) return showError("La valeur est requise pour ce type de proposition", "error");

            try {
                const tx = await contract.submitProposal(desc, val ? ethers.parseEther(val) : 0, addr, type);
                showToast("Envoi de la proposition...");
                await tx.wait();
                showToast("Proposition Soumise !");
                refreshData();
            } catch(e) {
                showError(e.reason || "Proposition Failed");
            }
        }

        async function loadProposal() {
            const id = document.getElementById('vote-proposal-id').value;
            if(!id) return showError("ID de proposition requis", "error");
            try {
                const p = await contract.proposals(id);
                if(p.id == 0n) return showError("Proposition non trouvée", "error");
                
                document.getElementById('proposal-data').style.display = 'block';
                document.getElementById('p-desc').innerText = p.description;
                
                document.getElementById('p-type').innerText = ["Burn", "Reward", "Pause", "Unlock", "News", "Maturity", "Quorum", "Threshold"][p.proposalType];
                document.getElementById('p-for').innerText = htmlDisplayEthers(p.forVotes);
                document.getElementById('p-against').innerText = htmlDisplayEthers(p.againstVotes);
            } catch(e) {
                showError("Erreur chargement proposition", "error");
            }
        }

        function processCommitVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('commit-secret').value;
            if(!id || !secret) return showError("ID ou Secret requis", "error");
            
            const secretBytes = ethers.toUtf8Bytes(secret);
            const hash = ethers.solidityPackedKeccak256(["bool", "bytes", "address"], [support, secretBytes, userAddress]);
            contract.commitVote(id, hash).then(tx => { showToast("Commit..."); return tx.wait(); })
            .then(() => { showToast("Committed !"); })
            .catch(e => showToast(e.reason, "error"));
        }

        function processRevealVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('reveal-secret').value;
            if(!id || !secret) return showError("ID ou Secret manquant", "error");
            
            const secretBytes = ethers.toUtf8Bytes(secret);
            contract.revealVote(id, support, secretBytes).then(tx => { showToast("Reveal..."); return tx.wait(); })
            .then(() => { showToast("Révélé !"); loadProposal(); })
            .catch(e => { showError("Révéale échouée", "error"); }
        }

        function handleDelegate() {
            const to = document.getElementById('delegate-to').value;
            const amt = document.getElementById('delegate-amount').value;
            if(!to || !amt) return showError("Remplissez tous les champs", "error");
            
            contract.delegateVote(to, ethers.parseEther(amt)).then(tx => { showToast("Délégation en cours..."); return tx.wait(); })
            .then(() => showToast("Délégué !"); })
            .catch(e => showError("Erreur Délégation", "error"));
        }

        function handleRevokeDelegate() {
            contract.revokeDelegation().then(tx => { showToast("Révocation..."); return tx.wait(); })
            .then(() => { showToast("Révoqué !"); })
            .catch(e => showError("Révocation échouée", "error"));
        }

        // --- DAPP VISUALS ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x030303, 0.0015);
            
            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10; camera.position.y = 3; camera.rotation.x = -0.3;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.PlaneGeometry(80, 80, 50, 50);
            const material = new THREE.ShaderMaterial({
                uniforms: { u_time: { value: 0 }, u_color: { value: new THREE.Color(0x00ff88) } },
                wireframe: true,
                vertexShader: `
                    uniform float u_time;
                    varying float vElev;
                    void main() {
                        vec4 p = modelMatrix * vec4(position, 1.0);
                        float d = distance(p.xz, vec2(0, 0));
                        float e = sin(d * 0.2 - u_time * 0.5) * 1.0;
                        e += sin(p.x * 0.5 + u_time * 0.3) * 0.5;
                        p.z += e; vElev = e;
                        gl_Position = projectionMatrix * viewMatrix * p;
                        gl_Position.z += e;
                        gl_Position.z -= e;
                    }
                `,
                fragmentShader: `
                    uniform vec3 u_color;
                    varying float vElev;
                    void main() {
                        float alpha = (vElev + 1.0) * 0.15;
                        gl_FragColor = vec4(u_color, alpha);
                        gl_FragColor.a *= (vElev + 1.0); // Boost visibility near top
                        gl_FragColor.a -= (vElev + 0.5); // Fade out towards bottom
                        gl_FragColor.a = clamp((vElev + 1.0), 0, 1.0); // Clamp alpha
                        gl_FragColor.a = mix(u_color, (vElev + 1.0), vElev + 0.5); // Ensure visibility
                        
                        gl_Position = projectionMatrix * gl_Position;
                        gl_Position.z += e;
                        gl_Position.y += e;
                        gl_Position.y -= e;
                        gl_Position.y += e; // Move camera down slightly if needed
                    }
                `
            });

            const plane = new THREE.Mesh(geometry, material);
            scene.add(plane);

            const animate = () => {
                requestAnimationFrame(animate);
                material.uniforms.u_time.value += 0.005;
                material.uniforms.u_color.value.y += 0.001; // Slow color shift over time
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Helper pour les nombres "BigNumber" (pour éviter le "Scientific Notation" ex: 10^18)
        function htmlDisplayEthers(bigInt) {
            if (bigInt == 0) return "0";
            
            // Conversion BigUint256 vers String pour nombres > 10000
            const div = 10000; // Nombre arbitrairement grand pour arrondir les sommes
            return bigInt.div(bigInt).toFixed(2); // Affiche 2 décimales
        }

        // Helper pour afficher les erreurs dans l'interface
        function showError(msg) {
            alert(msg);
            console.error(msg);
            showToast(msg, "error");
        }

        // --- THREE.JS BACKGROUND ---
        initThreeJS();

    </script>
</body>
</html>
