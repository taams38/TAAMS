<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAMS | Protocol Interface</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --glass: rgba(15, 15, 15, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --accent: #00ff88;
            --accent-glow: rgba(0, 255, 136, 0.2);
            --danger: #ff3333;
            --text-main: #ffffff;
            --text-dim: #888888;
            --font-head: 'Syncopate', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        /* --- WebGL Background --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.4; pointer-events: none;
        }

        /* --- Custom Cursor --- */
        .cursor {
            position: fixed; width: 8px; height: 8px; background: var(--accent);
            border-radius: 50%; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s;
            mix-blend-mode: difference;
        }
        .cursor.hovered { width: 50px; height: 50px; background: transparent; border: 1px solid var(--accent); }

        /* --- Sidebar --- */
        aside {
            width: 320px; border-right: 1px solid var(--border);
            padding: 2rem; display: flex; flex-direction: column;
            z-index: 10; background: var(--bg-color);
        }

        .brand {
            font-family: var(--font-head); font-size: 1.8rem; font-weight: 700;
            color: var(--accent); margin-bottom: 3rem; letter-spacing: -1px;
        }

        nav button {
            background: transparent; border: none; color: var(--text-dim);
            font-family: var(--font-body); font-size: 1rem;
            text-align: left; padding: 1rem 0; width: 100%;
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
        }
        nav button:hover { color: #fff; padding-left: 10px; }
        nav button.active { color: var(--accent); border-bottom: 1px solid var(--accent); }

        /* --- Main Content --- */
        main {
            flex: 1; padding: 2rem; overflow-y: auto; position: relative; z-index: 10;
            display: flex; flex-direction: column;
        }

        .section { display: none; animation: fadeIn 0.4s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .card {
            background: var(--glass); border: 1px solid var(--border);
            padding: 1.5rem; border-radius: 4px; margin-bottom: 1.5rem;
            backdrop-filter: blur(10px); transition: transform 0.2s;
        }
        .card:hover { border-color: rgba(255,255,255,0.2); }

        h2 { font-family: var(--font-head); font-size: 1.4rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
        h3 { font-size: 1.1rem; margin-bottom: 1rem; color: #fff; }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { text-align: center; padding: 2rem; }
        .stat-val { font-family: var(--font-head); font-size: 2rem; color: #fff; margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; }

        /* --- Forms --- */
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            color: #fff; padding: 0.8rem; font-family: var(--font-body);
            margin-bottom: 1rem; border-radius: 2px;
        }
        input:focus { outline: none; border-color: var(--accent); }

        .btn {
            background: var(--accent); color: #000; border: none; padding: 0.8rem 1.5rem;
            font-weight: 700; text-transform: uppercase; cursor: pointer;
            border-radius: 2px; transition: all 0.2s; font-family: var(--font-head);
            font-size: 0.8rem; display: inline-block; margin-right: 0.5rem;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px var(--accent-glow); }
        .btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
        .btn.secondary { background: transparent; border: 1px solid #fff; color: #fff; }
        .btn.secondary:hover { background: #fff; color: #000; }
        .btn.danger { background: var(--danger); color: #fff; }

        /* --- Status --- */
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 2px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .status-active { background: rgba(0,255,136,0.2); color: var(--accent); }
        .status-inactive { background: rgba(255,51,51,0.2); color: var(--danger); }

        /* --- Notifications --- */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; }
        .toast { background: #111; color: #fff; padding: 1rem; border-left: 4px solid var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.5); animation: slideIn 0.3s; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* --- Bottom Light Bar --- */
        .bottom-light { position: fixed; bottom: 0; left: 0; width: 100%; height: 4px; background: var(--accent); box-shadow: 0 -10px 40px 10px var(--accent); opacity: 0; transition: opacity 0.3s; z-index: 100; }

        /* Utility */
        .row { display: flex; gap: 1rem; }
        .full-width { width: 100%; }
        .text-dim { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; display: block; }
    </style>
</head>
<body>

    <div class="cursor" id="cursor"></div>
    <div id="toast-container"></div>
    <div class="bottom-light" id="bottom-light"></div>
    <div id="canvas-container"></div>

    <!-- Sidebar -->
    <aside>
        <div class="brand">TAAMS<span style="color:#fff; font-size:0.5em; vertical-align: middle; opacity: 0.5;">PROTOCOL</span></div>
        
        <nav>
            <button class="active" onclick="switchTab('dashboard')">Dashboard</button>
            <button onclick="switchTab('wallet')">Wallet & Permissions</button>
            <button onclick="switchTab('burn')">Burn Mechanism</button>
            <button onclick="switchTab('bl2p')">BL2P & Governance</button>
            <button onclick="switchTab('staking')">Staking</button>
            <button onclick="switchTab('airdrop')">Ignition Airdrop</button>
        </nav>

        <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--border);">
            <div id="wallet-display" class="text-dim" style="text-align:center;">Not Connected</div>
            <button id="connect-btn" class="btn full-width" onclick="connectWallet()">Connect Wallet</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main>

        <!-- DASHBOARD -->
        <section id="dashboard" class="section active">
            <h2>Protocol Overview</h2>
            <div class="stats-grid">
                <div class="card stat-card">
                    <div class="stat-val" id="dash-balance">0</div>
                    <div class="stat-label">TAAMS Balance</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-val" id="dash-bl2p">0</div>
                    <div class="stat-label">Valid BL2P</div>
                </div>
                <div class="card stat-card">
                    <div class="stat-val" id="dash-burned">0</div>
                    <div class="stat-label">Total Burned</div>
                </div>
            </div>

            <div class="card">
                <h3>Global Status</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <span class="text-dim">Burn Phase:</span>
                        <div id="status-burn" class="status-badge status-inactive">Checking...</div>
                    </div>
                    <div>
                        <span class="text-dim">BL2P Revealed:</span>
                        <div id="status-bl2p" class="status-badge status-inactive">Checking...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- WALLET -->
        <section id="wallet" class="section">
            <h2>Wallet & Permissions</h2>
            
            <div class="card">
                <h3>Approve Spending</h3>
                <span class="text-dim">You must approve the contract to spend your TAAMS for Staking.</span>
                <input type="number" id="approve-amount" placeholder="Amount to Approve">
                <button class="btn" onclick="handleApprove()">Approve TAAMS</button>
                <button class="btn secondary" onclick="document.getElementById('approve-amount').value = '999999999'">Set Unlimited</button>
                <div id="allowance-display" class="text-dim" style="margin-top:10px;">Current Allowance: 0</div>
            </div>

            <div class="card">
                <h3>Transfer TAAMS</h3>
                <input type="text" id="transfer-to" placeholder="Recipient Address (0x...)">
                <input type="number" id="transfer-amount" placeholder="Amount">
                <button class="btn" onclick="handleTransfer()">Transfer</button>
            </div>
        </section>

        <!-- BURN -->
        <section id="burn" class="section">
            <h2>Burn & Deflation</h2>
            
            <div class="card">
                <h3>Participate in Burn</h3>
                <span class="text-dim">Burn TAAMS to reduce supply and earn BL2P rewards.</span>
                <div style="margin-bottom: 1rem;">
                    <strong>Cycle Status:</strong> <span id="burn-cycle-info">Checking...</span><br>
                    <strong>Remaining Burnable:</strong> <span id="burn-remaining">...</span>
                </div>
                <input type="number" id="burn-amount" placeholder="Amount to Burn">
                <button class="btn" id="btn-burn" onclick="handleBurn()">Burn Tokens</button>
                <button class="btn secondary" onclick="setMax('burn-amount')">MAX</button>
            </div>

            <div class="card">
                <h3>Claim BL2P Reward</h3>
                <span class="text-dim">Claim your governance tokens after the burn phase ends.</span>
                <button class="btn" id="btn-claim-bl2p" onclick="handleClaimBL2P()">Claim BL2P</button>
            </div>
        </section>

        <!-- BL2P & GOVERNANCE -->
        <section id="bl2p" class="section">
            <h2>BL2P & Governance</h2>

            <div class="card">
                <h3>Vote (Commit & Reveal)</h3>
                <span class="text-dim">Voting happens in two steps to prevent bias.</span>
                
                <div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;">
                    <label style="font-size:0.8rem; color:var(--accent)">STEP 1: LOAD PROPOSAL</label>
                    <div class="row">
                        <input type="number" id="vote-proposal-id" placeholder="Proposal ID">
                        <button class="btn secondary" style="margin:0" onclick="loadProposal()">Load</button>
                    </div>
                </div>

                <div id="proposal-details" style="display:none; background: rgba(0,0,0,0.3); padding:1rem; margin-bottom:1rem;">
                    <p><strong>Description:</strong> <span id="p-desc"></span></p>
                    <p><strong>Type:</strong> <span id="p-type"></span></p>
                    <p><strong>For:</strong> <span id="p-for" style="color:var(--accent)"></span> | <strong>Against:</strong> <span id="p-against" style="color:var(--danger)"></span></p>
                </div>

                <div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;">
                    <label style="font-size:0.8rem; color:var(--accent)">STEP 2: COMMIT VOTE</label>
                    <input type="text" id="vote-secret" placeholder="Your Secret Password (Keep it safe!)">
                    <div class="row">
                        <button class="btn" onclick="processCommitVote(true)">Commit For</button>
                        <button class="btn danger" onclick="processCommitVote(false)">Commit Against</button>
                    </div>
                </div>

                <div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;">
                    <label style="font-size:0.8rem; color:var(--accent)">STEP 3: REVEAL VOTE</label>
                    <input type="text" id="reveal-secret" placeholder="Enter same Secret Password">
                    <div class="row">
                        <button class="btn secondary" onclick="processRevealVote(true)">Reveal For</button>
                        <button class="btn danger secondary" onclick="processRevealVote(false)">Reveal Against</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>Delegation</h3>
                <input type="text" id="delegate-to" placeholder="Delegate Address">
                <input type="number" id="delegate-amount" placeholder="BL2P Amount">
                <button class="btn" onclick="handleDelegate()">Delegate Votes</button>
                <button class="btn danger" onclick="handleRevokeDelegate()">Revoke</button>
            </div>
        </section>

        <!-- STAKING -->
        <section id="staking" class="section">
            <h2>Staking</h2>

            <div class="card">
                <h3>Stake TAAMS</h3>
                <span class="text-dim">Lock tokens to earn yield. You can boost rewards using BL2P.</span>
                <input type="number" id="stake-amount" placeholder="Amount">
                <button class="btn" onclick="handleStake()">Stake</button>
                <button class="btn secondary" onclick="setMax('stake-amount')">MAX</button>
            </div>

            <div class="card">
                <h3>Active Stake</h3>
                <div id="stake-info">Not staking.</div>
                
                <div style="margin-top:1rem; border-top:1px solid var(--border); padding-top:1rem;">
                    <span class="text-dim">Boost Stake with BL2P (Increases Yield)</span>
                    <input type="number" id="boost-amount" placeholder="BL2P to boost with">
                    <button class="btn secondary" onclick="handleBoost()">Boost</button>
                </div>

                <div style="margin-top:1rem;">
                    <button class="btn danger" onclick="handleUnstake()">Unstake All</button>
                </div>
            </div>
        </section>

        <!-- AIRDROP -->
        <section id="airdrop" class="section">
            <h2>Ignition Airdrop</h2>
            <div class="card">
                <h3>Status</h3>
                <div id="airdrop-status" style="margin-bottom:1rem;">Checking...</div>
                <button id="airdrop-action-btn" class="btn" onclick="handleAirdropAction()">Action</button>
            </div>
        </section>

    </main>

    <script>
        // ==========================================
        // CONFIGURATION & ABI (Extracted from Contract)
        // ==========================================
        
        // IMPORTANT: Remplacez ceci par l'adresse réelle de votre contrat déployé
        const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS_HERE"; 

        // ABI complet généré depuis le code source fourni
        const CONTRACT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 value) returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 value) returns (bool)",
            "function transferFrom(address sender, address recipient, uint256 value) returns (bool)",
            
            "function burnPhaseActive() view returns (bool)",
            "function bl2pRevealed() view returns (bool)",
            "function totalBurned() view returns (uint256)",
            "function participateInBurn(uint256 amount)",
            "function getRemainingBurnable() view returns (uint256)",
            "function claimBL2PReward()",
            "function getRemainingValidBL2P(address) view returns (uint256)",
            "function transferBL2P(address to, uint256 amount)",
            
            "function stake(uint256 amount)",
            "function unstake()",
            "function stakes(address) view returns (uint256 amount, uint256 startBlock, uint256 bl2pBoost, bool active)",
            "function useBL2PForStaking(uint256 bl2pAmount)",
            
            "function proposalCount() view returns (uint256)",
            "function proposals(uint256) view returns (uint256 id, uint256 startBlock, uint256 endBlock, uint256 newValue, uint256 forVotes, uint256 againstVotes, address proposer, address newAddress, string description, uint8 proposalType, bool executed)",
            "function commitVote(uint256 id, bytes32 commitHash)",
            "function revealVote(uint256 id, bool support, bytes32 secret)",
            "function submitProposal(string memory desc, uint256 newValue, address newAddress, uint8 proposalType)",
            "function executeProposal(uint256 id)",
            
            "function delegateVote(address delegate, uint256 amount)",
            "function revokeDelegation()",
            "function activeDelegations(address) view returns (address source, address delegate, uint256 bl2pAmount, uint256 delegationBlock)",
            
            "function getIgnitionInfo() view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed)",
            "function registerForIgnitionAirdrop()",
            "function claimIgnitionAirdrop()",
            "function triggerIgnitionAirdrop()", // Admin only usually
            "function updateBL2PMaturity(address user)", // Helper
        ];

        let provider, signer, userAddress, contract;
        let isConnected = false;

        // ==========================================
        // UI LOGIC
        // ==========================================
        
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }

        function showToast(msg, type='info') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div');
            el.className = 'toast';
            el.innerText = msg;
            if(type === 'error') el.style.borderLeftColor = 'var(--danger)';
            container.appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        function setMax(inputId) {
            const input = document.getElementById(inputId);
            const balance = ethers.formatEther(document.getElementById('dash-balance').getAttribute('data-raw'));
            input.value = Math.floor(balance * 100) / 100; // Clean float
        }

        // Custom Cursor
        document.addEventListener('mousemove', (e) => {
            const c = document.getElementById('cursor');
            c.style.left = e.clientX + 'px';
            c.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('button, input').forEach(el => {
            el.addEventListener('mouseenter', () => document.getElementById('cursor').classList.add('hovered'));
            el.addEventListener('mouseleave', () => document.getElementById('cursor').classList.remove('hovered'));
        });

        // ==========================================
        // WEB3 FUNCTIONS
        // ==========================================

        async function connectWallet() {
            if (!window.ethereum) return showToast("Please install Metamask", "error");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                isConnected = true;
                document.getElementById('wallet-display').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                document.getElementById('connect-btn').style.display = 'none';
                showToast("Wallet Connected");
                
                refreshData();
            } catch (err) {
                console.error(err);
                showToast("Connection failed", "error");
            }
        }

        async function refreshData() {
            if (!contract) return;
            try {
                // Dashboard Data
                const balRaw = await contract.balanceOf(userAddress);
                const bl2pRaw = await contract.getRemainingValidBL2P(userAddress);
                const burnedRaw = await contract.totalBurned();
                const isBurnActive = await contract.burnPhaseActive();
                const isBl2pRevealed = await contract.bl2pRevealed();

                document.getElementById('dash-balance').innerText = parseFloat(ethers.formatEther(balRaw)).toFixed(2);
                document.getElementById('dash-balance').setAttribute('data-raw', balRaw);
                document.getElementById('dash-bl2p').innerText = parseFloat(ethers.formatEther(bl2pRaw)).toFixed(2);
                document.getElementById('dash-burned').innerText = parseFloat(ethers.formatEther(burnedRaw)).toLocaleString();

                // Status Badges
                updateStatus('status-burn', isBurnActive);
                updateStatus('status-bl2p', isBl2pRevealed);

                // Burn Info
                const burnRemaining = await contract.getRemainingBurnable();
                document.getElementById('burn-remaining').innerText = parseFloat(ethers.formatEther(burnRemaining)).toFixed(2);
                document.getElementById('burn-cycle-info').innerText = isBurnActive ? "Active Cycle" : "Inactive";

                // Staking Info
                const stake = await contract.stakes(userAddress);
                if (stake.active) {
                    document.getElementById('stake-info').innerHTML = `
                        Amount: ${ethers.formatEther(stake.amount)} TAAMS<br>
                        BL2P Boost: ${ethers.formatEther(stake.bl2pBoost)} BL2P<br>
                        Active Since: ${new Date(stake.startBlock * 1000).toLocaleDateString()}
                    `;
                } else {
                    document.getElementById('stake-info').innerText = "Not staking.";
                }

                // Airdrop Info
                const airdrop = await contract.getIgnitionInfo();
                const adStatus = document.getElementById('airdrop-status');
                const adBtn = document.getElementById('airdrop-action-btn');
                
                adStatus.innerHTML = `
                    Triggered: ${airdrop.triggered}<br>
                    Registered: ${airdrop.userRegistered}<br>
                    Amount: ${ethers.formatEther(airdrop.userAmount)}
                `;
                
                if (!airdrop.triggered && airdrop.regOpen) {
                    adBtn.innerText = "Register";
                    adBtn.onclick = handleRegisterAirdrop;
                } else if (airdrop.triggered && airdrop.userRegistered && !airdrop.userClaimed && airdrop.userAmount > 0) {
                    adBtn.innerText = "Claim Airdrop";
                    adBtn.onclick = handleClaimAirdrop;
                } else {
                    adBtn.innerText = "Action Unavailable";
                    adBtn.disabled = true;
                }

            } catch (err) {
                // If contract not deployed yet
                console.log("Dev Note: Ensure Contract Address is set.");
            }
        }

        function updateStatus(id, active) {
            const el = document.getElementById(id);
            el.innerText = active ? "ACTIVE" : "INACTIVE";
            el.className = `status-badge ${active ? 'status-active' : 'status-inactive'}`;
        }

        // --- Permissions ---
        async function handleApprove() {
            const amt = document.getElementById('approve-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.approve(CONTRACT_ADDRESS, ethers.parseEther(amt));
                showToast("Approving...", "info");
                await tx.wait();
                showToast("Approved!");
            } catch(e) { showToast(e.reason || "Error", "error"); }
        }

        async function handleTransfer() {
            const to = document.getElementById('transfer-to').value;
            const amt = document.getElementById('transfer-amount').value;
            if(!to || !amt) return;
            try {
                const tx = await contract.transfer(to, ethers.parseEther(amt));
                showToast("Transferring...");
                await tx.wait();
                showToast("Transferred!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- Burn ---
        async function handleBurn() {
            const amt = document.getElementById('burn-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.participateInBurn(ethers.parseEther(amt));
                showToast("Burning...");
                await tx.wait();
                showToast("Burn Successful!");
                refreshData();
            } catch(e) { showToast(e.reason || "Burn failed (Check phase/balance)", "error"); }
        }

        async function handleClaimBL2P() {
            try {
                const tx = await contract.claimBL2PReward();
                showToast("Claiming...");
                await tx.wait();
                showToast("BL2P Claimed!");
                refreshData();
            } catch(e) { showToast(e.reason || "Claim conditions not met", "error"); }
        }

        // --- Staking ---
        async function handleStake() {
            const amt = document.getElementById('stake-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.stake(ethers.parseEther(amt));
                showToast("Staking...");
                await tx.wait();
                showToast("Staked Successfully!");
                refreshData();
            } catch(e) { showToast(e.reason || "Staking failed", "error"); }
        }

        async function handleBoost() {
            const amt = document.getElementById('boost-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.useBL2PForStaking(ethers.parseEther(amt));
                showToast("Boosting...");
                await tx.wait();
                showToast("Boosted!");
                refreshData();
            } catch(e) { showToast(e.reason || "Boost failed", "error"); }
        }

        async function handleUnstake() {
            try {
                const tx = await contract.unstake();
                showToast("Unstaking...");
                await tx.wait();
                showToast("Unstaked!");
                refreshData();
            } catch(e) { showToast(e.reason || "Unstake failed", "error"); }
        }

        // --- Governance (Complex Logic) ---
        async function loadProposal() {
            const id = document.getElementById('vote-proposal-id').value;
            if(!id) return;
            try {
                const p = await contract.proposals(id);
                if(p.id == 0) return showToast("Proposal not found", "error");
                
                document.getElementById('proposal-details').style.display = 'block';
                document.getElementById('p-desc').innerText = p.description;
                document.getElementById('p-type').innerText = p.proposalType; // Enum index
                document.getElementById('p-for').innerText = ethers.formatEther(p.forVotes);
                document.getElementById('p-against').innerText = ethers.formatEther(p.againstVotes);
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function processCommitVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('vote-secret').value;
            if(!id || !secret) return;

            // Generate Hash locally as required by Solidity: keccak256(abi.encode(support, secret, msg.sender))
            const secretBytes = ethers.toUtf8Bytes(secret);
            const commitHash = ethers.solidityPackedKeccak256(["bool", "bytes", "address"], [support, secretBytes, userAddress]);

            try {
                const tx = await contract.commitVote(id, commitHash);
                showToast("Committing Vote...");
                await tx.wait();
                showToast("Vote Committed!");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function processRevealVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('reveal-secret').value;
            if(!id || !secret) return;

            const secretBytes = ethers.toUtf8Bytes(secret);
            // Note: Contract expects bytes32, usually user sends string then solidity hashes. Here we pass the raw secret bytes.
            // The Solidity function is: revealVote(id, support, secret)
            // Solidity code: keccak256(abi.encode(support, secret, msg.sender))
            
            try {
                const tx = await contract.revealVote(id, support, secretBytes);
                showToast("Revealing Vote...");
                await tx.wait();
                showToast("Vote Revealed!");
                loadProposal(); // Refresh stats
            } catch(e) { showToast(e.reason || "Reveal failed", "error"); }
        }

        // --- Delegation ---
        async function handleDelegate() {
            const to = document.getElementById('delegate-to').value;
            const amt = document.getElementById('delegate-amount').value;
            if(!to || !amt) return;
            try {
                const tx = await contract.delegateVote(to, ethers.parseEther(amt));
                showToast("Delegating...");
                await tx.wait();
                showToast("Delegated!");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleRevokeDelegate() {
            try {
                const tx = await contract.revokeDelegation();
                showToast("Revoking...");
                await tx.wait();
                showToast("Revoked!");
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- Airdrop ---
        async function handleRegisterAirdrop() {
            try {
                const tx = await contract.registerForIgnitionAirdrop();
                showToast("Registering...");
                await tx.wait();
                showToast("Registered!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleClaimAirdrop() {
            try {
                const tx = await contract.claimIgnitionAirdrop();
                showToast("Claiming...");
                await tx.wait();
                showToast("Claimed!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // ==========================================
        // THREE.JS BACKGROUND
        // ==========================================
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10; camera.position.y = 3;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.PlaneGeometry(100, 100, 60, 60);
            const material = new THREE.ShaderMaterial({
                uniforms: { u_time: { value: 0 }, u_color: { value: new THREE.Color(0x00ff88) } },
                wireframe: true,
                vertexShader: `
                    uniform float u_time;
                    varying float vElevation;
                    void main() {
                        vec4 pos = modelMatrix * vec4(position, 1.0);
                        float e = sin(pos.x * 0.5 + u_time * 0.5) * 0.5;
                        e += sin(pos.y * 0.5 + u_time * 0.3) * 0.5;
                        pos.z += e; vElevation = e;
                        gl_Position = projectionMatrix * viewMatrix * pos;
                    }
                `,
                fragmentShader: `
                    uniform vec3 u_color;
                    varying float vElevation;
                    void main() {
                        float alpha = (vElevation + 1.0) * 0.2;
                        gl_FragColor = vec4(u_color, alpha);
                    }
                `
            });

            const plane = new THREE.Mesh(geometry, material);
            plane.rotation.x = -Math.PI / 2;
            scene.add(plane);

            const animate = () => {
                requestAnimationFrame(animate);
                material.uniforms.u_time.value += 0.01;
                plane.position.z = (Date.now() * 0.0002) % 2; 
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        initThreeJS();
    </script>
</body>
</html>
