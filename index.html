<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAMS Protocol | DApp Interface</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Ethers.js (Web3 Library) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <!-- Three.js (Visuals) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --bg-color: #050505;
            --card-bg: rgba(20, 20, 20, 0.6);
            --border-color: rgba(255, 255, 255, 0.15);
            --accent-color: #00ff88; /* TAAMS Green */
            --accent-glow: rgba(0, 255, 136, 0.3);
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --font-display: 'Syncopate', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
            --easing: cubic-bezier(0.23, 1, 0.32, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: var(--font-body);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* --- Custom Cursor --- */
        .cursor {
            position: fixed;
            width: 20px;
            height: 20px;
            border: 1px solid var(--accent-color);
            border-radius: 50%;
            pointer-events: none;
            z-index: 9999;
            transform: translate(-50%, -50%);
            transition: width 0.2s, height 0.2s, background-color 0.2s;
            mix-blend-mode: difference;
        }
        
        body:hover .cursor.hovered {
            width: 50px;
            height: 50px;
            background-color: rgba(0, 255, 136, 0.1);
            border-color: transparent;
        }

        /* --- WebGL Background --- */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            opacity: 0.4;
        }

        /* --- UI Layout --- */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 10;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .brand {
            font-family: var(--font-display);
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-color);
            letter-spacing: -1px;
        }

        .wallet-btn {
            background: transparent;
            border: 1px solid var(--accent-color);
            color: var(--accent-color);
            padding: 0.8rem 1.5rem;
            font-family: var(--font-display);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s var(--easing);
            position: relative;
            overflow: hidden;
        }

        .wallet-btn:hover {
            background: var(--accent-color);
            color: #000;
            box-shadow: 0 0 20px var(--accent-glow);
        }

        .wallet-btn.connected {
            border-color: #fff;
            color: #fff;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2rem;
            transition: transform 0.3s var(--easing), border-color 0.3s;
            position: relative;
            overflow: hidden;
        }

        .card:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px);
        }

        /* Specific Card Placements */
        .stats-card { grid-column: span 4; display: flex; flex-direction: column; justify-content: center; }
        .action-card { grid-column: span 8; }
        .stake-card { grid-column: span 6; }
        .airdrop-card { grid-column: span 6; }

        h2 {
            font-family: var(--font-display);
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        h2::before {
            content: '';
            display: block;
            width: 8px;
            height: 8px;
            background: var(--accent-color);
        }

        .big-number {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 0.5rem;
            font-variant-numeric: tabular-nums;
        }

        .label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Forms & Inputs */
        .input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        input[type="number"] {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 1rem;
            font-family: var(--font-body);
            font-size: 1.1rem;
            flex-grow: 1;
            border-radius: 2px;
            outline: none;
        }

        input[type="number"]:focus {
            border-color: var(--accent-color);
        }

        .action-btn {
            background: var(--accent-color);
            color: #000;
            border: none;
            padding: 0 2rem;
            font-weight: 700;
            text-transform: uppercase;
            font-family: var(--font-display);
            font-size: 0.9rem;
            border-radius: 2px;
            transition: all 0.3s;
        }

        .action-btn:hover {
            box-shadow: 0 0 30px var(--accent-glow);
            transform: scale(1.02);
        }

        .action-btn:disabled {
            background: #333;
            color: #666;
            cursor: not-allowed;
            box-shadow: none;
        }

        .secondary-btn {
            background: transparent;
            border: 1px solid #fff;
            color: #fff;
            padding: 0.8rem 1.5rem;
            font-family: var(--font-body);
            text-transform: uppercase;
            font-size: 0.8rem;
            margin-top: 1rem;
            transition: all 0.3s;
        }

        .secondary-btn:hover {
            background: #fff;
            color: #000;
        }

        /* Status Indicators */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: 1px solid;
            margin-bottom: 1rem;
        }

        .status-active { color: var(--accent-color); border-color: var(--accent-color); }
        .status-inactive { color: #ff4444; border-color: #ff4444; }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: #111;
            border-left: 4px solid var(--accent-color);
            padding: 1rem 1.5rem;
            color: #fff;
            min-width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideIn 0.3s var(--easing);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Loader */
        .loader {
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 900px) {
            .dashboard-grid { display: flex; flex-direction: column; }
            header { flex-direction: column; gap: 1rem; }
        }
    </style>
</head>
<body>

    <!-- Custom Cursor -->
    <div class="cursor" id="cursor"></div>

    <!-- WebGL Background -->
    <div id="canvas-container"></div>

    <!-- Notifications -->
    <div id="toast-container"></div>

    <div class="app-container">
        <header>
            <div class="brand">TAAMS <span style="color:#fff; font-size: 0.5em; vertical-align: middle; opacity: 0.5;">PROTOCOL</span></div>
            <button class="wallet-btn" id="connect-btn" onmouseenter="hoverEffect(true)" onmouseleave="hoverEffect(false)">Connect Wallet</button>
        </header>

        <main id="main-interface" style="display: none; opacity: 0; transition: opacity 0.5s;">
            
            <!-- Top Stats Row -->
            <div class="dashboard-grid" style="margin-bottom: 2rem;">
                <div class="card stats-card">
                    <div class="label">My TAAMS Balance</div>
                    <div class="big-number" id="user-balance">0.00</div>
                    <div style="color: var(--accent-color); font-size: 0.9rem;">Available to Burn</div>
                </div>
                <div class="card stats-card">
                    <div class="label">BL2P Rewards</div>
                    <div class="big-number" id="bl2p-balance">0.00</div>
                    <div style="color: var(--accent-color); font-size: 0.9rem;">Governance Power</div>
                </div>
                <div class="card stats-card">
                    <div class="label">Protocol Status</div>
                    <div style="margin-top: 1rem;">
                        <span id="burn-phase-status" class="status-badge status-inactive">Burn Phase Inactive</span>
                        <div style="font-size: 0.8rem; margin-top: 0.5rem; color: #666;" id="total-burned">Total Burned: 0 TAAMS</div>
                    </div>
                </div>
            </div>

            <!-- Actions Row -->
            <div class="dashboard-grid">
                
                <!-- Burn Section -->
                <div class="card action-card">
                    <h2>Participate in Burn</h2>
                    <p style="color: #888; margin-bottom: 1.5rem; max-width: 600px;">
                        Burn your TAAMS tokens to contribute to the deflationary mechanism and earn BL2P rewards.
                    </p>
                    <div class="input-group">
                        <input type="number" id="burn-amount" placeholder="Amount to Burn">
                        <button class="action-btn" onclick="handleBurn()">Burn Tokens</button>
                    </div>
                    <button class="secondary-btn" onclick="setMax('burn-amount')">MAX</button>
                </div>

                <!-- Staking Section -->
                <div class="card stake-card">
                    <h2>Stake TAAMS</h2>
                    <p style="color: #888; margin-bottom: 1rem;">Lock tokens to earn yield.</p>
                    <div class="input-group">
                        <input type="number" id="stake-amount" placeholder="Amount to Stake">
                        <button class="action-btn" onclick="handleStake()">Stake</button>
                    </div>
                    <button class="secondary-btn" onclick="handleUnstake()">Unstake All</button>
                </div>

                <!-- Airdrop Section -->
                <div class="card airdrop-card">
                    <h2>Ignition Airdrop</h2>
                    <div id="airdrop-status" style="margin-bottom: 1rem;">
                        <!-- Dynamic Content -->
                    </div>
                    <button id="airdrop-btn" class="action-btn" style="width: 100%;">Action</button>
                </div>

            </div>
        </main>

        <!-- Initial State / Not Connected -->
        <div id="landing-state" style="text-align: center; margin-top: 10vh;">
            <h1 style="font-family: var(--font-display); font-size: 4rem; line-height: 1; margin-bottom: 1rem;">TAAMS<br>ECOSYSTEM</h1>
            <p style="color: #888; max-width: 500px; margin: 0 auto;">Secure, Deflationary, Governance-driven.</p>
            <br>
            <div style="font-size: 3rem; color: #333; font-family: var(--font-display);">READY TO DEPLOY</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        // IMPORTANT: Remplacez ceci par l'adresse de votre contrat déployé
        const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS_HERE"; 

        // IMPORTANT: Collez votre ABI complet ici. 
        // J'ai inclus les fonctions minimales nécessaires pour la démo ci-dessous.
        const CONTRACT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function participateInBurn(uint256 amount)",
            "function stake(uint256 amount)",
            "function unstake()",
            "function registerForIgnitionAirdrop()",
            "function claimIgnitionAirdrop()",
            "function getIgnitionInfo() view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed)",
            "function getRemainingValidBL2P(address) view returns (uint256)",
            "function burnPhaseActive() view returns (bool)",
            "function totalBurned() view returns (uint256)"
        ];

        // Variables Globales
        let provider, signer, userAddress, contract;
        let isConnected = false;

        // ==========================================
        // UI INTERACTIONS (CURSOR, TOASTS)
        // ==========================================
        const cursor = document.getElementById('cursor');
        
        document.addEventListener('mousemove', (e) => {
            cursor.style.left = e.clientX + 'px';
            cursor.style.top = e.clientY + 'px';
        });

        const hoverElements = document.querySelectorAll('button, input, a, .card');
        hoverElements.forEach(el => {
            el.addEventListener('mouseenter', () => cursor.classList.add('hovered'));
            el.addEventListener('mouseleave', () => cursor.classList.remove('hovered'));
        });

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.style.borderLeftColor = type === 'error' ? '#ff4444' : '#00ff88';
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function setMax(inputId) {
            const input = document.getElementById(inputId);
            if(inputId === 'burn-amount') input.value = document.getElementById('user-balance').innerText;
        }

        // ==========================================
        // WEB3 LOGIC
        // ==========================================

        const connectBtn = document.getElementById('connect-btn');

        connectBtn.addEventListener('click', async () => {
            if (!isConnected) {
                await connectWallet();
            }
        });

        async function connectWallet() {
            if (!window.ethereum) {
                showToast("Metamask not found!", "error");
                return;
            }

            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                const accounts = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                
                // Init Contract
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                isConnected = true;
                updateUIOnConnect();
                refreshData();
                
                showToast("Wallet Connected Successfully");
            } catch (error) {
                console.error(error);
                showToast("Connection Failed", "error");
            }
        }

        function updateUIOnConnect() {
            connectBtn.innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
            connectBtn.classList.add('connected');
            
            document.getElementById('landing-state').style.display = 'none';
            const main = document.getElementById('main-interface');
            main.style.display = 'block';
            setTimeout(() => main.style.opacity = '1', 100);
        }

        async function refreshData() {
            if (!contract) return;

            try {
                // Fetch Balances
                const balRaw = await contract.balanceOf(userAddress);
                const bl2pRaw = await contract.getRemainingValidBL2P(userAddress);
                const totalBurnedRaw = await contract.totalBurned();
                const isBurnActive = await contract.burnPhaseActive();

                // Update DOM (Format from Wei to Ether)
                document.getElementById('user-balance').innerText = parseFloat(ethers.formatEther(balRaw)).toFixed(2);
                document.getElementById('bl2p-balance').innerText = parseFloat(ethers.formatEther(bl2pRaw)).toFixed(2);
                document.getElementById('total-burned').innerText = `Total Burned: ${parseFloat(ethers.formatEther(totalBurnedRaw)).toLocaleString()} TAAMS`;

                const burnBadge = document.getElementById('burn-phase-status');
                if (isBurnActive) {
                    burnBadge.innerText = "BURN PHASE ACTIVE";
                    burnBadge.className = "status-badge status-active";
                } else {
                    burnBadge.innerText = "BURN PHASE INACTIVE";
                    burnBadge.className = "status-badge status-inactive";
                }

                // Airdrop Info Logic
                const airdropInfo = await contract.getIgnitionInfo();
                const adStatusDiv = document.getElementById('airdrop-status');
                const adBtn = document.getElementById('airdrop-btn');

                if (airdropInfo.triggered) {
                    if (airdropInfo.userClaimed) {
                        adStatusDiv.innerHTML = "<span style='color:#888'>Airdrop Already Claimed</span>";
                        adBtn.disabled = true;
                        adBtn.innerText = "CLAIMED";
                    } else if (airdropInfo.userRegistered) {
                        adStatusDiv.innerHTML = `<span style='color:var(--accent-color)'>Claimable: ${parseFloat(ethers.formatEther(airdropInfo.userAmount)).toFixed(2)} TAAMS</span>`;
                        adBtn.disabled = false;
                        adBtn.innerText = "CLAIM AIRDROP";
                        adBtn.onclick = handleClaimAirdrop;
                    } else {
                        adStatusDiv.innerHTML = "<span style='color:#ff4444'>Not Registered</span>";
                        adBtn.disabled = true;
                    }
                } else {
                    if (airdropInfo.regOpen) {
                        if (airdropInfo.userRegistered) {
                            adStatusDiv.innerHTML = `<span style='color:var(--accent-color)'>Registered! (${airdropInfo.participants}/${airdropInfo.maxParticipants})</span>`;
                            adBtn.disabled = true;
                            adBtn.innerText = "REGISTERED";
                        } else {
                            adStatusDiv.innerHTML = "<span>Registration is Open</span>";
                            adBtn.disabled = false;
                            adBtn.innerText = "REGISTER";
                            adBtn.onclick = handleRegisterAirdrop;
                        }
                    } else {
                        adStatusDiv.innerHTML = "<span>Registration Closed</span>";
                        adBtn.disabled = true;
                    }
                }

            } catch (error) {
                console.error("Error fetching data", error);
                // Fallback if contract address isn't real yet
                if (CONTRACT_ADDRESS.includes("YOUR")) {
                    showToast("Please set valid Contract Address in code", "error");
                }
            }
        }

        // ==========================================
        // CONTRACT ACTIONS
        // ==========================================

        async function handleBurn() {
            const amountInput = document.getElementById('burn-amount');
            const amount = amountInput.value;
            if (!amount || amount <= 0) return showToast("Invalid amount", "error");

            try {
                const tx = await contract.participateInBurn(ethers.parseEther(amount));
                showToast("Transaction sent...");
                await tx.wait();
                showToast("Burn Successful!", "success");
                amountInput.value = "";
                refreshData();
            } catch (error) {
                console.error(error);
                showToast("Burn Failed (check allowance/balance)", "error");
            }
        }

        async function handleStake() {
            const amountInput = document.getElementById('stake-amount');
            const amount = amountInput.value;
            if (!amount || amount <= 0) return showToast("Invalid amount", "error");

            try {
                // Note: You need to Approve the contract to spend your tokens first if not ERC20Approve handled
                // Assuming standard ERC20 approval flow is needed or allowance is infinite
                // For this demo, I'll call approve then stake
                const txApprove = await contract.approve(CONTRACT_ADDRESS, ethers.MaxUint256); // Helper if in ABI, else needs ERC20 ABI
                // Since ABI is minimal, let's assume user has approval or contract handles transferFrom logic via specific functions.
                // The contract provided uses transferFrom inside stake, so we must approve.
                
                // Quick check if approve is in ABI:
                if(CONTRACT_ABI.includes("function approve(address,uint256)")) {
                     // Approve first
                     await contract.approve(CONTRACT_ADDRESS, ethers.parseEther(amount));
                }

                const tx = await contract.stake(ethers.parseEther(amount));
                showToast("Staking...");
                await tx.wait();
                showToast("Staking Successful!");
                refreshData();
            } catch (error) {
                console.error(error);
                showToast("Staking Failed", "error");
            }
        }

        async function handleUnstake() {
            try {
                const tx = await contract.unstake();
                showToast("Unstaking...");
                await tx.wait();
                showToast("Unstaked Successfully!");
                refreshData();
            } catch (error) {
                showToast("Unstake Failed", "error");
            }
        }

        async function handleRegisterAirdrop() {
            try {
                const tx = await contract.registerForIgnitionAirdrop();
                showToast("Registering...");
                await tx.wait();
                showToast("Registered for Airdrop!");
                refreshData();
            } catch (error) {
                showToast("Registration Failed", "error");
            }
        }

        async function handleClaimAirdrop() {
            try {
                const tx = await contract.claimIgnitionAirdrop();
                showToast("Claiming...");
                await tx.wait();
                showToast("Airdrop Claimed!");
                refreshData();
            } catch (error) {
                showToast("Claim Failed", "error");
            }
        }

        // ==========================================
        // THREE.JS BACKGROUND (Grid Terrain)
        // ==========================================
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            // Fog to blend into background
            scene.fog = new THREE.FogExp2(0x050505, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10;
            camera.position.y = 3;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            // Grid Geometry
            const geometry = new THREE.PlaneGeometry(100, 100, 40, 40);
            
            // Custom Shader Material for the Grid
            const material = new THREE.ShaderMaterial({
                uniforms: {
                    u_time: { value: 0 },
                    u_color: { value: new THREE.Color(0x00ff88) }
                },
                wireframe: true,
                vertexShader: `
                    uniform float u_time;
                    varying float vElevation;
                    void main() {
                        vec4 modelPosition = modelMatrix * vec4(position, 1.0);
                        float elevation = sin(modelPosition.x * 0.5 + u_time * 0.5) * 0.5;
                        elevation += sin(modelPosition.y * 0.5 + u_time * 0.3) * 0.5;
                        
                        modelPosition.z += elevation;
                        vElevation = elevation;
                        
                        gl_Position = projectionMatrix * viewMatrix * modelPosition;
                    }
                `,
                fragmentShader: `
                    uniform vec3 u_color;
                    varying float vElevation;
                    void main() {
                        float alpha = (vElevation + 1.0) * 0.3; // Fade based on elevation
                        gl_FragColor = vec4(u_color, alpha);
                    }
                `
            });

            const plane = new THREE.Mesh(geometry, material);
            plane.rotation.x = -Math.PI / 2;
            scene.add(plane);

            const animate = () => {
                requestAnimationFrame(animate);
                material.uniforms.u_time.value += 0.01;
                
                // Subtle movement
                plane.position.z = (Date.now() * 0.0005) % 2; 

                renderer.render(scene, camera);
            };

            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        initThreeJS();

    </script>
</body>
</html>
