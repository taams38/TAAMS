<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAAMS | Autonomous Protocol</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;700&family=Syncopate:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --bg-color: #030303;
            --panel-bg: rgba(10, 10, 10, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --accent: #00ff88; /* TAAMS Green */
            --accent-glow: rgba(0, 255, 136, 0.15);
            --secondary: #ff00ff;
            --text-main: #ffffff;
            --text-dim: #666666;
            --font-head: 'Syncopate', sans-serif;
            --font-body: 'Space Grotesk', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; cursor: none; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: var(--font-body);
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        /* --- WebGL Background --- */
        #canvas-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; opacity: 0.6; pointer-events: none;
        }

        /* --- Custom Cursor --- */
        .cursor {
            position: fixed; width: 6px; height: 6px; background: var(--accent);
            border-radius: 50%; pointer-events: none; z-index: 9999;
            transform: translate(-50%, -50%); transition: width 0.2s, height 0.2s;
            mix-blend-mode: exclusion;
        }
        .cursor.hovered { width: 60px; height: 60px; background: transparent; border: 1px solid var(--accent); opacity: 0.8; }

        /* --- Sidebar --- */
        aside {
            width: 300px; border-right: 1px solid var(--border);
            padding: 2rem; display: flex; flex-direction: column;
            z-index: 10; background: var(--bg-color);
        }

        .brand {
            font-family: var(--font-head); font-size: 1.6rem; font-weight: 700;
            color: var(--text-main); margin-bottom: 3rem; letter-spacing: -1px;
            text-transform: uppercase;
        }
        .brand span { color: var(--accent); }

        nav button {
            background: transparent; border: none; color: var(--text-dim);
            font-family: var(--font-body); font-size: 0.9rem;
            text-align: left; padding: 1rem 0; width: 100%;
            transition: all 0.3s; text-transform: uppercase; letter-spacing: 1px;
            border-left: 2px solid transparent;
        }
        nav button:hover { color: #fff; padding-left: 1rem; }
        nav button.active { color: var(--accent); border-left: 2px solid var(--accent); background: linear-gradient(90deg, rgba(0,255,136,0.05), transparent); }

        /* --- Main Content --- */
        main {
            flex: 1; padding: 3rem; overflow-y: auto; position: relative; z-index: 10;
            display: flex; flex-direction: column;
        }

        .section { display: none; animation: fadeIn 0.5s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Components --- */
        .card {
            background: var(--panel-bg); border: 1px solid var(--border);
            padding: 2rem; border-radius: 4px; margin-bottom: 2rem;
            backdrop-filter: blur(15px); transition: transform 0.2s;
            position: relative; overflow: hidden;
        }
        .card:hover { border-color: rgba(255,255,255,0.2); }
        
        .card-header { font-family: var(--font-head); font-size: 1.2rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; display: flex; justify-content: space-between;}

        /* --- Vitality Meter (The "Life" of the Protocol) --- */
        .vitality-container {
            text-align: center; padding: 3rem 1rem;
            background: linear-gradient(180deg, rgba(0,255,136,0.05) 0%, transparent 100%);
            border: 1px solid var(--accent); margin-bottom: 3rem;
        }
        .vitality-title { font-family: var(--font-head); font-size: 2rem; margin-bottom: 1rem; color: #fff; }
        .progress-track { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; margin: 1rem auto; max-width: 600px; }
        .progress-fill { height: 100%; background: var(--accent); width: 0%; transition: width 1s ease; box-shadow: 0 0 20px var(--accent); }
        .vitality-stats { display: flex; justify-content: center; gap: 2rem; margin-top: 1.5rem; font-size: 1.2rem; color: var(--text-dim); }
        .vitality-stat span { color: #fff; font-weight: bold; }

        /* --- Stats Grid --- */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-item { background: rgba(255,255,255,0.03); padding: 1.5rem; border: 1px solid var(--border); }
        .stat-val { font-family: var(--font-head); font-size: 1.8rem; color: #fff; margin-bottom: 0.5rem; }
        .stat-label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; }

        /* --- Forms --- */
        input, select, textarea {
            width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--border);
            color: #fff; padding: 1rem; font-family: var(--font-body);
            margin-bottom: 1rem; border-radius: 2px; font-size: 1rem;
        }
        input:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .btn {
            background: var(--accent); color: #000; border: none; padding: 1rem 2rem;
            font-weight: 700; text-transform: uppercase; cursor: pointer;
            border-radius: 2px; transition: all 0.2s; font-family: var(--font-head);
            font-size: 0.9rem; display: inline-block; margin-right: 0.5rem;
            position: relative; overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px var(--accent-glow); letter-spacing: 1px; }
        .btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; background: #333; color: #888; }
        .btn.secondary { background: transparent; border: 1px solid #fff; color: #fff; }
        .btn.secondary:hover { background: #fff; color: #000; }
        .btn.danger { background: var(--danger); color: #fff; }

        /* --- Notifications --- */
        #toast-container { position: fixed; bottom: 2rem; right: 2rem; z-index: 100; display: flex; flex-direction: column; gap: 0.5rem; pointer-events: none; }
        .toast { background: #111; color: #fff; padding: 1rem; border-left: 4px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.5); animation: slideIn 0.3s; pointer-events: auto; min-width: 300px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* --- Vote Styles --- */
        .vote-step { border-left: 3px solid var(--border); padding-left: 1.5rem; margin-bottom: 2rem; position: relative; }
        .vote-step::before { content:''; position: absolute; left: -9px; top: 0; width: 15px; height: 15px; background: var(--bg-color); border: 2px solid var(--text-dim); border-radius: 50%; }
        .vote-step.active::before { border-color: var(--accent); background: var(--accent); box-shadow: 0 0 10px var(--accent); }
        .step-title { font-weight: bold; color: var(--accent); text-transform: uppercase; font-size: 0.8rem; margin-bottom: 0.5rem; display: block; }

        /* --- Footer --- */
        .protocol-footer { margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--border); text-align: center; color: #444; font-size: 0.8rem; }

        /* Utility */
        .text-dim { color: var(--text-dim); font-size: 0.9rem; margin-bottom: 1rem; display: block; line-height: 1.5; }
        .highlight { color: var(--accent); }
    </style>
</head>
<body>

    <div class="cursor" id="cursor"></div>
    <div id="toast-container"></div>
    <div id="canvas-container"></div>

    <!-- Sidebar -->
    <aside>
        <div class="brand">TAAMS <span>PROTOCOL</span></div>
        
        <nav>
            <button class="active" onclick="switchTab('dashboard')">Vitality & Ignition</button>
            <button onclick="switchTab('wallet')">Wallet</button>
            <button onclick="switchTab('burn')">Burn & BL2P</button>
            <button onclick="switchTab('staking')">Staking</button>
            <button onclick="switchTab('governance')">DAO & Governance</button>
        </nav>

        <div style="margin-top: auto;">
            <div id="wallet-status" class="text-dim" style="text-align:center; margin-bottom:1rem;">Disconnected</div>
            <button id="connect-btn" class="btn full-width" style="width:100%" onclick="connectWallet()">CONNECT</button>
        </div>
    </aside>

    <!-- Main Content -->
    <main>

        <!-- DASHBOARD / VITALITY -->
        <section id="dashboard" class="section active">
            
            <!-- The Heart of the Protocol -->
            <div class="card vitality-container">
                <div class="vitality-title">PROTOCOL VITALITY</div>
                <p class="text-dim">The system depends entirely on community participation.</p>
                
                <div class="progress-track">
                    <div id="vitality-bar" class="progress-fill"></div>
                </div>
                
                <div class="vitality-stats">
                    <div class="vitality-stat"><span id="ign-count">0</span> / 1000</div>
                    <div class="vitality-stat">Founders</div>
                </div>

                <div id="ignition-message" style="margin-top: 2rem; font-family: var(--font-head);">
                    <!-- Dynamic Message -->
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-val" id="dash-balance">0</div>
                    <div class="stat-label">Your TAAMS</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="dash-bl2p">0</div>
                    <div class="stat-label">Governance Power</div>
                </div>
                <div class="stat-item">
                    <div class="stat-val" id="dash-burned">0</div>
                    <div class="stat-label">Total Burned</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">System Status</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                    <div>
                        <span class="text-dim">Burn Phase:</span>
                        <div id="status-burn" style="color: #fff;">Checking...</div>
                    </div>
                    <div>
                        <span class="text-dim">Ignition Triggered:</span>
                        <div id="status-ignition" style="color: #fff;">Checking...</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- WALLET -->
        <section id="wallet" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Wallet Management</h2>
            
            <div class="card">
                <div class="card-header">Permissions (Approvals)</div>
                <span class="text-dim">Authorize the protocol to manage your assets for Staking or Operations.</span>
                <div style="display:flex; gap:1rem;">
                    <input type="number" id="approve-amount" placeholder="TAAMS Amount">
                    <button class="btn" onclick="handleApprove()">APPROVE</button>
                </div>
                <div id="allowance-info" class="text-dim" style="font-size:0.8rem;">Current Allowance: Loading...</div>
            </div>

            <div class="card">
                <div class="card-header">Transfer</div>
                <span class="text-dim">Send TAAMS to another wallet address.</span>
                <input type="text" id="transfer-to" placeholder="Recipient Address (0x...)">
                <input type="number" id="transfer-amount" placeholder="Amount">
                <button class="btn" onclick="handleTransfer()">TRANSFER</button>
            </div>
        </section>

        <!-- BURN & BL2P -->
        <section id="burn" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Deflation & Governance</h2>

            <div class="card">
                <div class="card-header">Incinerate Tokens (Burn)</div>
                <span class="text-dim">Burning TAAMS permanently reduces supply and grants you BL2P (Governance Power). <br>The protocol lives through deflation.</span>
                
                <div style="margin: 1rem 0; padding:1rem; background:rgba(255,255,255,0.05);">
                    <span class="text-dim">Remaining in Cycle:</span> <span id="burn-remaining" class="highlight">Loading...</span>
                </div>

                <div style="display:flex; gap:1rem;">
                    <input type="number" id="burn-amount" placeholder="Amount to Burn">
                    <button class="btn" id="btn-burn" onclick="handleBurn()">BURN</button>
                </div>
                <button class="btn secondary" onclick="setInputMax('burn-amount')">SET MAX</button>
            </div>

            <div class="card">
                <div class="card-header">Claim Governance Rights (BL2P)</div>
                <span class="text-dim">Claim your voting power. This is non-transferable until maturity.</span>
                <button class="btn" id="btn-claim-bl2p" onclick="handleClaimBL2P()">CLAIM BL2P</button>
            </div>
        </section>

        <!-- STAKING -->
        <section id="staking" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Yield Generation</h2>

            <div class="card">
                <div class="card-header">Stake TAAMS</div>
                <span class="text-dim">Lock your tokens to generate yield. The protocol rewards patience.</span>
                
                <div style="margin-bottom:1rem;">
                    <input type="number" id="stake-amount" placeholder="Amount to Stake">
                    <button class="btn" onclick="handleStake()">STAKE</button>
                    <button class="btn secondary" onclick="setInputMax('stake-amount')">MAX</button>
                </div>

                <div id="user-stake-info" class="text-dim">You are not currently staking.</div>
                
                <div style="margin-top:2rem; border-top:1px solid var(--border); padding-top:1rem;">
                    <span class="text-dim">BOOST YIELD WITH BL2P</span>
                    <p style="font-size:0.8rem; color:#666; margin-bottom:1rem;">Sacrifice some voting power to increase your TAAMS yield.</p>
                    <input type="number" id="boost-amount" placeholder="BL2P to Burn for Boost">
                    <button class="btn secondary" onclick="handleBoost()">BOOST STAKE</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Unstake</div>
                <span class="text-dim">Unlock your assets and claim rewards.</span>
                <button class="btn danger" onclick="handleUnstake()">UNSTAKE ALL</button>
            </div>
        </section>

        <!-- GOVERNANCE -->
        <section id="governance" class="section">
            <h2 style="font-family:var(--font-head); margin-bottom:2rem;">Community Control</h2>

            <div class="card">
                <div class="card-header">Create Proposal</div>
                <span class="text-dim">Shape the future of the protocol. Requires Voting Power.</span>
                
                <select id="proposal-type">
                    <option value="0">Change Annual Burn Amount</option>
                    <option value="1">Change Staking Reward Rate</option>
                    <option value="2">Emergency Pause Protocol</option>
                    <option value="3">Unlock Reserve (Treasury)</option>
                    <option value="4">Post Advertisement (News)</option>
                    <option value="5">Adjust BL2P Maturation Time</option>
                    <option value="6">Change Quorum</option>
                </select>
                <input type="text" id="proposal-desc" placeholder="Proposal Description / News Message">
                <input type="number" id="proposal-value" placeholder="New Value (if applicable)">
                <input type="text" id="proposal-address" placeholder="New Address (if applicable)">
                <button class="btn" onclick="handleSubmitProposal()">SUBMIT PROPOSAL</button>
            </div>

            <div class="card">
                <div class="card-header">Vote (Commit & Reveal)</div>
                <span class="text-dim">Voting is anonymous and split into two phases to prevent corruption.</span>
                
                <!-- Step 1 -->
                <div class="vote-step">
                    <span class="step-title">Step 1: Load Proposal</span>
                    <div style="display:flex; gap:1rem;">
                        <input type="number" id="vote-proposal-id" placeholder="Proposal ID">
                        <button class="btn secondary" style="margin:0" onclick="loadProposal()">LOAD</button>
                    </div>
                    <div id="proposal-data" style="margin-top:1rem; display:none; background:rgba(0,0,0,0.3); padding:1rem;">
                        <p><strong>Desc:</strong> <span id="p-desc" style="color:var(--accent)"></span></p>
                        <p><strong>Type:</strong> <span id="p-type"></span></p>
                        <div style="display:flex; gap:2rem; margin-top:0.5rem;">
                            <span class="highlight">FOR: <span id="p-for"></span></span>
                            <span style="color:var(--secondary)">AGAINST: <span id="p-against"></span></span>
                        </div>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="vote-step">
                    <span class="step-title">Step 2: Commit Vote (Hide Choice)</span>
                    <input type="password" id="commit-secret" placeholder="Enter a Secret Password (Keep it!)">
                    <div style="display:flex; gap:1rem;">
                        <button class="btn" onclick="processCommitVote(true)">FOR</button>
                        <button class="btn danger" onclick="processCommitVote(false)">AGAINST</button>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="vote-step">
                    <span class="step-title">Step 3: Reveal Vote</span>
                    <input type="password" id="reveal-secret" placeholder="Enter the SAME Secret Password">
                    <div style="display:flex; gap:1rem;">
                        <button class="btn secondary" onclick="processRevealVote(true)">REVEAL FOR</button>
                        <button class="btn danger secondary" onclick="processRevealVote(false)">REVEAL AGAINST</button>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">Delegation</div>
                <span class="text-dim">Trust an expert to vote on your behalf.</span>
                <input type="text" id="delegate-to" placeholder="Delegate Address">
                <input type="number" id="delegate-amount" placeholder="BL2P Amount">
                <button class="btn" onclick="handleDelegate()">DELEGATE</button>
                <button class="btn danger" onclick="handleRevokeDelegate()">REVOKE</button>
            </div>
        </section>

        <div class="protocol-footer">
            TAAMS PROTOCOL // AUTONOMOUS SYSTEM // COMMUNITY DRIVEN
        </div>

    </main>

    <script>
        // ==========================================
        // CONFIGURATION
        // ==========================================
        
        // IMPORTANT: ADRESSE DU CONTRAT
        const CONTRACT_ADDRESS = "YOUR_DEPLOYED_CONTRACT_ADDRESS_HERE"; 

        const CONTRACT_ABI = [
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function balanceOf(address) view returns (uint256)",
            "function allowance(address owner, address spender) view returns (uint256)",
            "function approve(address spender, uint256 value) returns (bool)",
            "function transfer(address to, uint256 value) returns (bool)",
            
            "function burnPhaseActive() view returns (bool)",
            "function bl2pRevealed() view returns (bool)",
            "function totalBurned() view returns (uint256)",
            "function getRemainingBurnable() view returns (uint256)",
            "function participateInBurn(uint256 amount)",
            "function claimBL2PReward()",
            "function getRemainingValidBL2P(address) view returns (uint256)",
            
            "function stake(uint256 amount)",
            "function unstake()",
            "function useBL2PForStaking(uint256 bl2pAmount)",
            "function stakes(address) view returns (uint256 amount, uint256 startBlock, uint256 bl2pBoost, bool active)",
            
            "function proposalCount() view returns (uint256)",
            "function proposals(uint256) view returns (uint256 id, uint256 startBlock, uint256 endBlock, uint256 newValue, uint256 forVotes, uint256 againstVotes, address proposer, address newAddress, string description, uint8 proposalType, bool executed)",
            "function submitProposal(string memory desc, uint256 newValue, address newAddress, uint8 proposalType)",
            "function commitVote(uint256 id, bytes32 commitHash)",
            "function revealVote(uint256 id, bool support, bytes32 secret)",
            
            "function delegateVote(address delegate, uint256 amount)",
            "function revokeDelegation()",
            
            "function getIgnitionInfo() view returns (bool triggered, bool regOpen, uint256 participants, uint256 maxParticipants, bool userRegistered, uint256 userAmount, bool userClaimed)",
            "function registerForIgnitionAirdrop()",
            "function claimIgnitionAirdrop()"
        ];

        let provider, signer, userAddress, contract;
        let isConnected = false;

        // ==========================================
        // UI UTILITIES
        // ==========================================
        function switchTab(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.target.classList.add('active');
        }

        function showToast(msg, type='info') {
            const c = document.getElementById('toast-container');
            const t = document.createElement('div');
            t.className = 'toast';
            t.innerText = msg;
            if(type === 'error') t.style.borderLeftColor = '#ff00ff';
            c.appendChild(t);
            setTimeout(() => t.remove(), 4000);
        }

        function setInputMax(id) {
            const el = document.getElementById(id);
            const bal = document.getElementById('dash-balance').getAttribute('data-raw');
            el.value = parseFloat(ethers.formatEther(bal)).toFixed(2);
        }

        // Cursor
        document.addEventListener('mousemove', e => {
            const c = document.getElementById('cursor');
            c.style.left = e.clientX + 'px';
            c.style.top = e.clientY + 'px';
        });
        document.querySelectorAll('button, input').forEach(el => {
            el.addEventListener('mouseenter', () => document.getElementById('cursor').classList.add('hovered'));
            el.addEventListener('mouseleave', () => document.getElementById('cursor').classList.remove('hovered'));
        });

        // ==========================================
        // WEB3 LOGIC
        // ==========================================
        async function connectWallet() {
            if (!window.ethereum) return showToast("Metamask not found", "error");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                isConnected = true;
                
                document.getElementById('wallet-status').innerText = `${userAddress.substring(0,6)}...${userAddress.substring(38)}`;
                document.getElementById('connect-btn').style.display = 'none';
                showToast("Connected to Autonomous Protocol");
                
                // Auto-refresh loop for vitality
                setInterval(refreshData, 5000);
                refreshData();
            } catch (err) { console.error(err); showToast("Connection Failed", "error"); }
        }

        async function refreshData() {
            if (!contract) return;
            try {
                // --- Vitality & Ignition ---
                const ignInfo = await contract.getIgnitionInfo();
                const currentCount = Number(ignInfo.participants);
                const maxCount = 1000;
                const percent = Math.min((currentCount / maxCount) * 100, 100);
                
                document.getElementById('ign-count').innerText = currentCount;
                document.getElementById('vitality-bar').style.width = `${percent}%`;
                
                const msgDiv = document.getElementById('ignition-message');
                if(!ignInfo.triggered) {
                    if(ignInfo.regOpen) {
                        if(ignInfo.userRegistered) {
                            msgDiv.innerHTML = `<span class="highlight">YOU ARE REGISTERED.</span><br><span class="text-dim">Waiting for 1000 founders to ignite...</span>`;
                        } else {
                            msgDiv.innerHTML = `<button class="btn" onclick="handleRegisterAirdrop()">JOIN IGNITION</button>`;
                        }
                    } else {
                        msgDiv.innerHTML = `<span style="color:var(--secondary)">REGISTRATION CLOSED</span>`;
                    }
                } else {
                    if(ignInfo.userRegistered && !ignInfo.userClaimed && ignInfo.userAmount > 0n) {
                        msgDiv.innerHTML = `<button class="btn" onclick="handleClaimAirdrop()">CLAIM YOUR TAAMS</button>`;
                    } else {
                        msgDiv.innerHTML = `<span class="highlight">IGNITION COMPLETE</span><br><span class="text-dim">The protocol is live.</span>`;
                    }
                }

                // --- Dashboard Stats ---
                const bal = await contract.balanceOf(userAddress);
                const bl2p = await contract.getRemainingValidBL2P(userAddress);
                const burned = await contract.totalBurned();
                
                document.getElementById('dash-balance').innerText = parseFloat(ethers.formatEther(bal)).toFixed(2);
                document.getElementById('dash-balance').setAttribute('data-raw', bal);
                document.getElementById('dash-bl2p').innerText = parseFloat(ethers.formatEther(bl2p)).toFixed(2);
                document.getElementById('dash-burned').innerText = parseFloat(ethers.formatEther(burned)).toLocaleString();

                document.getElementById('status-burn').innerText = await contract.burnPhaseActive() ? "ACTIVE" : "INACTIVE";
                document.getElementById('status-ignition').innerText = ignInfo.triggered ? "YES" : "NO";

                // --- Burn Info ---
                const rem = await contract.getRemainingBurnable();
                document.getElementById('burn-remaining').innerText = ethers.formatEther(rem);

                // --- Staking Info ---
                const stake = await contract.stakes(userAddress);
                if(stake.active) {
                    document.getElementById('user-stake-info').innerHTML = `
                        Active Stake: <span class="highlight">${ethers.formatEther(stake.amount)} TAAMS</span><br>
                        Boost: ${ethers.formatEther(stake.bl2pBoost)} BL2P<br>
                        Locked Since: ${new Date(Number(stake.startBlock) * 1000).toLocaleDateString()}
                    `;
                }

            } catch(e) { /* Ignore refresh errors if contract not ready */ }
        }

        // --- WALLET ---
        async function handleApprove() {
            const amt = document.getElementById('approve-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.approve(CONTRACT_ADDRESS, ethers.parseEther(amt));
                showToast("Processing Approval...");
                await tx.wait();
                showToast("Approved!");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleTransfer() {
            const to = document.getElementById('transfer-to').value;
            const amt = document.getElementById('transfer-amount').value;
            if(!to || !amt) return;
            try {
                const tx = await contract.transfer(to, ethers.parseEther(amt));
                showToast("Transferring...");
                await tx.wait();
                showToast("Transfer Complete");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- IGNITION ---
        async function handleRegisterAirdrop() {
            try {
                const tx = await contract.registerForIgnitionAirdrop();
                showToast("Registering...");
                await tx.wait();
                showToast("Registered Successfully!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleClaimAirdrop() {
            try {
                const tx = await contract.claimIgnitionAirdrop();
                showToast("Claiming...");
                await tx.wait();
                showToast("Claimed!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- BURN ---
        async function handleBurn() {
            const amt = document.getElementById('burn-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.participateInBurn(ethers.parseEther(amt));
                showToast("Burning Tokens...");
                await tx.wait();
                showToast("Burn Complete");
                refreshData();
            } catch(e) { showToast(e.reason || "Burn Failed", "error"); }
        }

        async function handleClaimBL2P() {
            try {
                const tx = await contract.claimBL2PReward();
                showToast("Claiming Governance Power...");
                await tx.wait();
                showToast("BL2P Claimed!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- STAKING ---
        async function handleStake() {
            const amt = document.getElementById('stake-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.stake(ethers.parseEther(amt));
                showToast("Staking...");
                await tx.wait();
                showToast("Staked Successfully");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleBoost() {
            const amt = document.getElementById('boost-amount').value;
            if(!amt) return;
            try {
                const tx = await contract.useBL2PForStaking(ethers.parseEther(amt));
                showToast("Boosting Yield...");
                await tx.wait();
                showToast("Boosted!");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleUnstake() {
            try {
                const tx = await contract.unstake();
                showToast("Unstaking...");
                await tx.wait();
                showToast("Unstaked");
                refreshData();
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- GOVERNANCE ---
        async function handleSubmitProposal() {
            const type = document.getElementById('proposal-type').value;
            const desc = document.getElementById('proposal-desc').value;
            const val = document.getElementById('proposal-value').value;
            const addr = document.getElementById('proposal-address').value;
            
            try {
                const tx = await contract.submitProposal(desc, val ? ethers.parseEther(val) : 0, addr, type);
                showToast("Submitting Proposal...");
                await tx.wait();
                showToast("Proposal Submitted!");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function loadProposal() {
            const id = document.getElementById('vote-proposal-id').value;
            if(!id) return;
            try {
                const p = await contract.proposals(id);
                if(p.id == 0n) return showToast("Proposal not found", "error");
                
                document.getElementById('proposal-data').style.display = 'block';
                document.getElementById('p-desc').innerText = p.description;
                document.getElementById('p-type').innerText = ["Burn", "Reward", "Pause", "Unlock", "News", "Maturity", "Quorum"][p.proposalType];
                document.getElementById('p-for').innerText = ethers.formatEther(p.forVotes);
                document.getElementById('p-against').innerText = ethers.formatEther(p.againstVotes);
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function processCommitVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('commit-secret').value;
            if(!id || !secret) return;

            const secretBytes = ethers.toUtf8Bytes(secret);
            const hash = ethers.solidityPackedKeccak256(["bool", "bytes", "address"], [support, secretBytes, userAddress]);
            
            try {
                const tx = await contract.commitVote(id, hash);
                showToast("Committing Vote...");
                await tx.wait();
                showToast("Vote Committed (Hidden)");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function processRevealVote(support) {
            const id = document.getElementById('vote-proposal-id').value;
            const secret = document.getElementById('reveal-secret').value;
            if(!id || !secret) return;

            const secretBytes = ethers.toUtf8Bytes(secret);
            try {
                const tx = await contract.revealVote(id, support, secretBytes);
                showToast("Revealing...");
                await tx.wait();
                showToast("Vote Revealed!");
                loadProposal();
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleDelegate() {
            const to = document.getElementById('delegate-to').value;
            const amt = document.getElementById('delegate-amount').value;
            if(!to || !amt) return;
            try {
                const tx = await contract.delegateVote(to, ethers.parseEther(amt));
                showToast("Delegating...");
                await tx.wait();
                showToast("Delegation Active");
            } catch(e) { showToast(e.reason, "error"); }
        }

        async function handleRevokeDelegate() {
            try {
                const tx = await contract.revokeDelegation();
                showToast("Revoking...");
                await tx.wait();
                showToast("Revoked");
            } catch(e) { showToast(e.reason, "error"); }
        }

        // --- THREE.JS BACKGROUND ---
        function initThreeJS() {
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x030303, 0.0015);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 10; camera.position.y = 3; camera.rotation.x = -0.3;

            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            container.appendChild(renderer.domElement);

            const geometry = new THREE.PlaneGeometry(80, 80, 50, 50);
            const material = new THREE.ShaderMaterial({
                uniforms: { u_time: { value: 0 }, u_color: { value: new THREE.Color(0x00ff88) } },
                wireframe: true,
                vertexShader: `
                    uniform float u_time;
                    varying float vElev;
                    void main() {
                        vec4 p = modelMatrix * vec4(position, 1.0);
                        float d = distance(p.xz, vec2(0.0));
                        float e = sin(d * 0.2 - u_time * 0.5) * 1.0;
                        e += sin(p.x * 0.5 + u_time * 0.3) * 0.5;
                        p.z += e; vElev = e;
                        gl_Position = projectionMatrix * viewMatrix * p;
                    }
                `,
                fragmentShader: `
                    uniform vec3 u_color;
                    varying float vElev;
                    void main() {
                        float alpha = (vElev + 1.0) * 0.15;
                        gl_FragColor = vec4(u_color, alpha);
                    }
                `
            });

            const plane = new THREE.Mesh(geometry, material);
            scene.add(plane);

            const animate = () => {
                requestAnimationFrame(animate);
                material.uniforms.u_time.value += 0.005;
                renderer.render(scene, camera);
            };
            animate();

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }
        initThreeJS();

    </script>
</body>
</html>
